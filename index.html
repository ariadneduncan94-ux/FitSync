<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Arsenal Health</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #000; color: #fff; }
    .app { max-width: 430px; margin: 0 auto; min-height: 100vh; background: #000; position: relative; padding-bottom: 90px; }
    .header { background: #000; padding: 50px 20px 12px; display: flex; justify-content: space-between; align-items: center; }
    .logo-text { font-size: 18px; font-style: italic; letter-spacing: 1px; }
    .logo-bold { font-weight: 800; color: #f5f5dc; }
    .logo-light { font-weight: 300; color: #f5f5dc; }
    .accent { color: #4169E1; }
    .role-badge { font-size: 10px; padding: 6px 12px; border-radius: 20px; background: #1a1a1a; border: 1px solid #333; cursor: pointer; }
    .role-badge.trainer { background: #4169E120; border-color: #4169E1; color: #4169E1; }
    .card { background: #111; margin: 12px 16px; border-radius: 16px; padding: 18px; border: 1px solid #222; }
    .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; font-size: 11px; font-weight: 600; color: #888; letter-spacing: 1.5px; }
    .stats-row { display: flex; justify-content: space-around; align-items: center; }
    .stat-item { text-align: center; flex: 1; }
    .stat-value { font-size: 28px; font-weight: 700; }
    .stat-label { font-size: 10px; color: #666; margin-top: 4px; text-transform: uppercase; letter-spacing: 1px; }
    .stat-divider { width: 1px; height: 40px; background: #333; }
    .recovery-high { color: #00ff88; }
    .recovery-med { color: #ffcc00; }
    .recovery-low { color: #4169E1; }
    .screen { display: none; }
    .screen.active { display: block; }
    .tab-bar { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 430px; background: #111; display: flex; border-top: 1px solid #222; padding: 10px 0 25px; z-index: 50; }
    .tab { flex: 1; text-align: center; cursor: pointer; color: #555; font-size: 10px; font-weight: 500; }
    .tab.active { color: #4169E1; }
    .tab-icon { display: block; margin-bottom: 4px; height: 22px; }
    .tab-icon svg { width: 22px; height: 22px; fill: currentColor; }
    .fab { position: fixed; bottom: 100px; right: calc(50% - 195px); width: 56px; height: 56px; border-radius: 28px; background: #4169E1; color: #fff; border: none; font-size: 28px; cursor: pointer; box-shadow: 0 4px 20px rgba(65,105,225,0.4); z-index: 50; }
    .brand-logo { width: 20px; height: 20px; margin-right: 10px; vertical-align: middle; border-radius: 4px; }
    .source-row { display: flex; align-items: center; }
  </style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="msg-btn" onclick="openMessages()"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg><span class="msg-badge" id="msg-badge">2</span></div>
    <div class="logo-text"><span class="logo-bold">ARSENAL</span><span class="logo-light">HEALTH</span></div>
    <div class="role-badge" id="role-badge" onclick="toggleRole()">CLIENT</div>
  </div>

  <!-- CLIENT: Dashboard -->
  <div id="dashboard" class="screen active">
    <div class="card">
      <div class="card-header">TODAY'S BIOMETRICS</div>
      <div class="stats-row">
        <div class="stat-item"><div class="stat-value recovery-high" id="recovery-score">78%</div><div class="stat-label">Recovery</div></div>
        <div class="stat-divider"></div>
        <div class="stat-item"><div class="stat-value" id="hrv-score">45</div><div class="stat-label">HRV</div></div>
        <div class="stat-divider"></div>
        <div class="stat-item"><div class="stat-value" id="strain-score">--</div><div class="stat-label">Strain</div></div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">TODAY'S NUTRITION TARGET</div>
      <div class="macro-grid" id="nutrition-targets"></div>
    </div>
    <div class="card">
      <div class="card-header">TODAY'S WORKOUT <span class="scheduled-date" id="today-date"></span></div>
      <div id="todays-workout"></div>
    </div>
    <div class="card">
      <div class="card-header">UPCOMING WORKOUTS</div>
      <div id="upcoming-workouts"></div>
    </div>
  </div>

  <!-- CLIENT: Program -->
  <div id="program" class="screen">
    <div style="padding:16px;">
      <div class="card-header">UPCOMING SESSIONS</div>
      <div id="client-sessions-calendar"></div>
      <div class="card-header" style="margin-top:20px;">MY WORKOUTS</div>
      <div class="week-nav"><span onclick="prevWeek()">←</span><span id="week-label">This Week</span><span onclick="nextWeek()">→</span></div>
      <div id="program-calendar"></div>
    </div>
  </div>

  <!-- CLIENT: Analytics -->
  <div id="analytics" class="screen">
    <div style="padding:16px;">
      <div class="card-header">ANALYTICS</div>
      <div class="time-toggle">
        <button class="time-btn active" onclick="setTimeRange('1M')">1M</button>
        <button class="time-btn" onclick="setTimeRange('3M')">3M</button>
        <button class="time-btn" onclick="setTimeRange('6M')">6M</button>
      </div>
      <div class="card" style="padding:12px;height:220px;"><canvas id="analyticsChart"></canvas></div>
      
      <div class="card-header" style="margin-top:16px;">RAW DATA SUMMARY</div>
      <div id="raw-data-summary" class="card" style="background:#0a0a0a;"></div>
      
      <div class="card-header" style="margin-top:16px;">CORRELATION INSIGHTS</div>
      <div id="correlation-insights" class="card" style="background:#0a0a0a;"></div>
      
      <div class="card-header" style="margin-top:16px;">SELECT METRICS</div>
      <div id="legend-grid"></div>
    </div>
  </div>

  <!-- CLIENT: Labs -->
  <div id="labs" class="screen">
    <div style="padding:16px;">
      <div class="card-header">KEY TRENDS <span style="font-size:9px;color:#00ff88;font-weight:400;">● Auto-synced</span></div>
      <div id="labs-trends" class="card" style="background:#0a0a0a;"></div>
      <div class="card-header" style="margin-top:20px;">BLOOD PANEL HISTORY</div>
      <div id="labs-list"></div>
      <p style="font-size:11px;color:#555;text-align:center;margin-top:16px;">Lab results are uploaded by your trainer from partner labs</p>
    </div>
  </div>

  <!-- TRAINER: Clients -->
  <div id="clients" class="screen">
    <div style="padding:16px;">
      <div class="card-header">MY CLIENTS</div>
      <div id="clients-list"></div>
      <div class="card" style="margin-top:20px;background:#0a0a0a;">
        <div class="card-header">IMPORT PROGRAMMING - ALL CLIENTS</div>
        <div class="import-option" onclick="connectTrueCoach()">
          <img src="https://images.crunchbase.com/image/upload/c_pad,h_256,w_256,f_auto,q_auto:eco,dpr_1/v1455512033/pnqpvlkdqyqxlqganb0e.png" class="brand-logo" alt="TrueCoach">
          <span>TrueCoach</span>
          <span id="truecoach-status" class="source-status" style="margin-left:auto;">Connect</span>
        </div>
        <div class="import-option" onclick="connectTrainerize()">
          <img src="https://play-lh.googleusercontent.com/Gp0RWjLPxMmGpMx_xyN9hPnriB8JEVM1w-gfPzLFqwQYzPRXingdGracnlXff-wkjw=w240-h480-rw" class="brand-logo" alt="Trainerize">
          <span>Trainerize</span>
          <span id="trainerize-status" class="source-status" style="margin-left:auto;">Connect</span>
        </div>
        <div style="border-top:1px solid #222;margin:12px 0;padding-top:12px;">
          <p style="font-size:10px;color:#555;margin-bottom:8px;">OR UPLOAD CSV MANUALLY</p>
          <button class="btn-small" onclick="downloadBulkTemplate()" style="margin-right:8px;font-size:11px;">Download Template</button>
          <label class="btn-small" style="background:#333;cursor:pointer;font-size:11px;">
            Upload CSV
            <input type="file" accept=".xlsx,.xls,.csv" onchange="handleBulkExcelUpload(event)" style="display:none;">
          </label>
        </div>
      </div>
      <div class="card" style="margin-top:12px;background:#0a0a0a;">
        <div class="card-header">LAB RESULTS</div>
        <p style="font-size:11px;color:#666;margin-bottom:12px;">Upload blood panel results for clients</p>
        <button class="btn-small" onclick="openLabsModal()" style="width:100%;">Upload Lab Results</button>
      </div>
    </div>
  </div>

  <!-- TRAINER: Builder -->
  <div id="builder" class="screen">
    <div style="padding:16px;">
      <div class="card-header">PROGRAM BUILDER <span id="builder-client-name"></span></div>
      <div class="card" style="margin-bottom:16px;background:#0a0a0a;">
        <div class="card-header">IMPORT PROGRAMMING</div>
        <div class="import-option" onclick="importFromTrueCoach()">
          <img src="https://images.crunchbase.com/image/upload/c_pad,h_256,w_256,f_auto,q_auto:eco,dpr_1/v1455512033/pnqpvlkdqyqxlqganb0e.png" class="brand-logo" alt="TrueCoach">
          <span>Import from TrueCoach</span>
        </div>
        <div class="import-option" onclick="importFromTrainerize()">
          <img src="https://play-lh.googleusercontent.com/Gp0RWjLPxMmGpMx_xyN9hPnriB8JEVM1w-gfPzLFqwQYzPRXingdGracnlXff-wkjw=w240-h480-rw" class="brand-logo" alt="Trainerize">
          <span>Import from Trainerize</span>
        </div>
        <div style="border-top:1px solid #222;margin:12px 0;padding-top:12px;">
          <p style="font-size:10px;color:#555;margin-bottom:8px;">OR UPLOAD CSV MANUALLY</p>
          <button class="btn-small" onclick="downloadClientTemplate()" style="margin-right:8px;font-size:11px;">Download Template</button>
          <label class="btn-small" style="background:#333;cursor:pointer;font-size:11px;">
            Upload CSV
            <input type="file" accept=".xlsx,.xls,.csv" onchange="handleClientExcelUpload(event)" style="display:none;">
          </label>
        </div>
      </div>
      <div class="week-nav"><span onclick="builderPrevWeek()">←</span><span id="builder-week-label">This Week</span><span onclick="builderNextWeek()">→</span></div>
      <div id="builder-calendar"></div>
      <div class="card" style="margin-top:16px;">
        <div class="card-header">NUTRITION TARGETS</div>
        <div class="nutrition-inputs">
          <div class="nut-input"><label>Protein</label><input type="number" id="nut-protein" placeholder="g"></div>
          <div class="nut-input"><label>Carbs</label><input type="number" id="nut-carbs" placeholder="g"></div>
          <div class="nut-input"><label>Fats</label><input type="number" id="nut-fats" placeholder="g"></div>
          <div class="nut-input"><label>Calories</label><input type="number" id="nut-calories" placeholder="kcal"></div>
        </div>
        <button class="btn-small" onclick="saveNutritionTargets()">Save Targets</button>
      </div>
    </div>
  </div>

  <!-- TRAINER: Client Health Dashboard -->
  <div id="client-health" class="screen">
    <div style="padding:16px;">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
        <span onclick="showScreen('clients')" style="cursor:pointer;font-size:20px;color:#666;">←</span>
        <div class="card-header" style="margin:0;" id="health-client-name">Client</div>
      </div>
      
      <div class="card" style="background:#0a0a0a;">
        <div style="text-align:center;">
          <div style="font-size:11px;color:#666;letter-spacing:1px;">OVERALL COMPLIANCE</div>
          <div id="health-compliance-score" style="font-size:48px;font-weight:800;margin:8px 0;"></div>
          <div id="health-compliance-label" style="font-size:12px;"></div>
        </div>
      </div>
      
      <div class="card-header" style="margin-top:20px;">AREAS TO WATCH</div>
      <div id="health-alerts"></div>
      
      <div class="card-header" style="margin-top:20px;">7-DAY BREAKDOWN</div>
      <div class="card">
        <div class="health-metric-row">
          <span>Calorie Compliance</span>
          <span id="health-cal-compliance"></span>
        </div>
        <div class="health-metric-row">
          <span>Protein Compliance</span>
          <span id="health-protein-compliance"></span>
        </div>
        <div class="health-metric-row">
          <span>Sleep Average</span>
          <span id="health-sleep-avg"></span>
        </div>
        <div class="health-metric-row">
          <span>Recovery Average</span>
          <span id="health-recovery-avg"></span>
        </div>
        <div class="health-metric-row">
          <span>Workouts Completed</span>
          <span id="health-workouts"></span>
        </div>
      </div>
      
      <div class="card-header" style="margin-top:20px;">RECENT BIOMETRICS</div>
      <div class="card">
        <div class="health-metric-row">
          <span>Body Weight</span>
          <span id="health-weight"></span>
        </div>
        <div class="health-metric-row">
          <span>Body Fat %</span>
          <span id="health-bf"></span>
        </div>
        <div class="health-metric-row">
          <span>Squat PR</span>
          <span id="health-squat"></span>
        </div>
        <div class="health-metric-row">
          <span>Deadlift PR</span>
          <span id="health-deadlift"></span>
        </div>
        <div class="health-metric-row">
          <span>Bench PR</span>
          <span id="health-bench"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- TRAINER: Sessions Calendar -->
  <div id="sessions" class="screen">
    <div style="padding:16px;">
      <div class="card" style="background:#0a0a0a;">
        <div class="revenue-summary">
          <div class="revenue-item"><div class="revenue-value" id="revenue-today">$0</div><div class="revenue-label">Today</div></div>
          <div class="revenue-item"><div class="revenue-value" id="revenue-week">$0</div><div class="revenue-label">This Week</div></div>
          <div class="revenue-item"><div class="revenue-value" id="revenue-month">$0</div><div class="revenue-label">This Month</div></div>
        </div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin:16px 0 12px;">
        <div class="time-toggle" style="margin:0;flex:1;">
          <button class="time-btn active" onclick="setCalendarView('week')">Week</button>
          <button class="time-btn" onclick="setCalendarView('month')">Month</button>
        </div>
        <span id="calendly-status" class="source-status" onclick="connectCalendly()" style="cursor:pointer;margin-left:12px;">Calendly</span>
      </div>
      <div class="week-nav"><span onclick="calendarPrev()">←</span><span id="calendar-label">This Week</span><span onclick="calendarNext()">→</span></div>
      <div id="sessions-calendar"></div>
      <div class="card-header" style="margin-top:20px;">SESSION LIST</div>
      <div id="trainer-sessions-list"></div>
    </div>
  </div>

  <!-- TRAINER: Business Dashboard -->
  <div id="business" class="screen">
    <div style="padding:16px;">
      <div class="card-header">BUSINESS OVERVIEW</div>
      <div class="card" style="background:#0a0a0a;">
        <div class="revenue-summary">
          <div class="revenue-item"><div class="revenue-value" id="biz-revenue-month">$0</div><div class="revenue-label">This Month</div></div>
          <div class="revenue-item"><div class="revenue-value" id="biz-revenue-projected">$0</div><div class="revenue-label">Projected</div></div>
          <div class="revenue-item"><div class="revenue-value" id="biz-sessions-count">0</div><div class="revenue-label">Sessions</div></div>
        </div>
      </div>
      
      <div class="card-header" style="margin-top:20px;">REVENUE BY TRAINER</div>
      <div id="trainer-revenue-list"></div>
      
      <div class="card-header" style="margin-top:20px;">MONTHLY BREAKDOWN</div>
      <div class="card" style="padding:12px;height:180px;"><canvas id="revenueChart"></canvas></div>
      
      <div class="card-header" style="margin-top:20px;">CLIENT RETENTION</div>
      <div class="card">
        <div class="biz-stat-row">
          <span>Active Clients</span>
          <span id="biz-active-clients" style="color:#00ff88;font-weight:600;">0</span>
        </div>
        <div class="biz-stat-row">
          <span>Avg Sessions/Client/Week</span>
          <span id="biz-avg-sessions" style="color:#4169E1;font-weight:600;">0</span>
        </div>
        <div class="biz-stat-row">
          <span>Client Lifetime Value</span>
          <span id="biz-ltv" style="color:#ffaa00;font-weight:600;">$0</span>
        </div>
      </div>
    </div>
  </div>

  <!-- TRAINER: Billing -->
  <div id="billing" class="screen">
    <div style="padding:16px;">
      <div class="card-header">BILLING OVERVIEW</div>
      <div class="card" style="background:#0a0a0a;">
        <div class="revenue-summary">
          <div class="revenue-item"><div class="revenue-value" id="billing-collected">$0</div><div class="revenue-label">Collected</div></div>
          <div class="revenue-item"><div class="revenue-value" id="billing-pending" style="color:#ffaa00;">$0</div><div class="revenue-label">Pending</div></div>
          <div class="revenue-item"><div class="revenue-value" id="billing-overdue" style="color:#ff6b6b;">$0</div><div class="revenue-label">Overdue</div></div>
        </div>
      </div>
      
      <div class="card-header" style="margin-top:20px;">PAYMENT INTEGRATIONS</div>
      <div class="card">
        <div class="import-option" onclick="connectPaddle()">
          <img src="https://images.crunchbase.com/image/upload/c_pad,h_256,w_256,f_auto,q_auto:eco,dpr_1/v1505375214/ggqhvyfdqsxfpufigcsa.png" class="brand-logo" alt="Paddle">
          <span>Paddle</span>
          <span id="paddle-status" class="source-status" style="margin-left:auto;">Connect</span>
        </div>
        <div class="import-option" onclick="connectStripe()">
          <img src="https://cdn.brandfetch.io/idxAg10C0L/theme/dark/symbol.svg?c=1dxbfHSJFAPEGdCLU4o5B" class="brand-logo" alt="Stripe">
          <span>Stripe</span>
          <span id="stripe-status" class="source-status" style="margin-left:auto;">Connect</span>
        </div>
        <div class="import-option" onclick="connectSquare()">
          <img src="https://cdn.brandfetch.io/idVxYBVkue/w/400/h/400/theme/dark/icon.png?c=1dxbfHSJFAPEGdCLU4o5B" class="brand-logo" alt="Square">
          <span>Square</span>
          <span id="square-status" class="source-status" style="margin-left:auto;">Connect</span>
        </div>
        <div class="import-option" onclick="connectQuickbooks()">
          <img src="https://cdn.brandfetch.io/id_KsyK7J9/w/400/h/400/theme/dark/icon.jpeg?c=1dxbfHSJFAPEGdCLU4o5B" class="brand-logo" alt="QuickBooks">
          <span>QuickBooks</span>
          <span id="quickbooks-status" class="source-status" style="margin-left:auto;">Connect</span>
        </div>
      </div>
      
      <div class="card-header" style="margin-top:20px;">RECENT TRANSACTIONS</div>
      <div id="billing-transactions"></div>
      
      <div class="card-header" style="margin-top:20px;">CLIENT BILLING STATUS</div>
      <div id="client-billing-list"></div>
    </div>
  </div>

  <!-- Settings -->
  <div id="settings" class="screen">
    <div style="padding:16px;">
      <div class="card">
        <div style="display:flex;align-items:center;gap:16px;">
          <div class="avatar">A</div>
          <div><div style="font-weight:600;font-size:18px;">Ari</div><div style="color:#666;font-size:13px;">ari@arsenalhealth.com</div></div>
        </div>
      </div>
      <div class="card-header" style="margin:24px 0 12px;">DATA SOURCES</div>
      <div class="card">
        <div class="setting-row" onclick="toggleSource('whoop')">
          <span class="source-row"><img src="https://play-lh.googleusercontent.com/Hl5KOEMoqJhMjqjGwlhGcFJjqGGnBs_rDV8JY1LmFDMVmRV7jNnXj5GpXQvPKj5Sxw=w240-h480-rw" class="brand-logo" alt="Whoop">Whoop</span>
          <span id="whoop-status" class="source-status">Connect</span>
        </div>
        <div class="setting-row" onclick="toggleSource('apple')">
          <span class="source-row"><img src="https://cdn.brandfetch.io/idnrCPuv87/w/400/h/400/theme/dark/icon.png?c=1dxbfHSJFAPEGdCLU4o5B" class="brand-logo" alt="Apple">Apple Health</span>
          <span id="apple-status" class="source-status">Connect</span>
        </div>
        <div class="setting-row" onclick="toggleSource('garmin')">
          <span class="source-row"><img src="https://cdn.brandfetch.io/idFdXEmeEd/w/400/h/400/theme/dark/icon.jpeg?c=1dxbfHSJFAPEGdCLU4o5B" class="brand-logo" alt="Garmin">Garmin</span>
          <span id="garmin-status" class="source-status">Connect</span>
        </div>
        <div class="setting-row" onclick="toggleSource('oura')">
          <span class="source-row"><img src="https://cdn.brandfetch.io/idkfqVXOu-/w/400/h/400/theme/dark/icon.png?c=1dxbfHSJFAPEGdCLU4o5B" class="brand-logo" alt="Oura">Oura Ring</span>
          <span id="oura-status" class="source-status">Connect</span>
        </div>
      </div>
      <div class="card-header" style="margin:24px 0 12px;">NUTRITION IMPORT</div>
      <div class="card">
        <div class="setting-row" onclick="connectFatSecret()">
          <span class="source-row"><img src="https://cdn.brandfetch.io/idGOxJTVNe/w/400/h/400/theme/dark/icon.png?c=1dxbfHSJFAPEGdCLU4o5B" class="brand-logo" alt="FatSecret">FatSecret</span>
          <span id="fatsecret-status" class="source-status">Connect</span>
        </div>
        <p style="font-size:11px;color:#555;padding:8px 0 0;">Sync your daily nutrition data automatically</p>
      </div>
      <button class="btn-outline" onclick="clearData()">Clear All Data</button>
    </div>
  </div>

  <button class="fab" id="fab-btn" onclick="handleFab()">+</button>

  <div class="tab-bar" id="client-tabs">
    <div class="tab active" onclick="showScreen('dashboard')"><span class="tab-icon"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></span>Home</div>
    <div class="tab" onclick="showScreen('program')"><span class="tab-icon"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg></span>Program</div>
    <div class="tab" onclick="showScreen('labs')"><span class="tab-icon"><svg viewBox="0 0 24 24"><path d="M7 2v2h1v14a4 4 0 0 0 8 0V4h1V2H7zm4 14c-.6 0-1-.4-1-1s.4-1 1-1 1 .4 1 1-.4 1-1 1zm2-4c-.6 0-1-.4-1-1s.4-1 1-1 1 .4 1 1-.4 1-1 1zm1-5h-4V4h4v3z"/></svg></span>Labs</div>
    <div class="tab" onclick="showScreen('analytics')"><span class="tab-icon"><svg viewBox="0 0 24 24"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg></span>Analytics</div>
    <div class="tab" onclick="showScreen('settings')"><span class="tab-icon"><svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg></span>Settings</div>
  </div>
  <div class="tab-bar" id="trainer-tabs" style="display:none;">
    <div class="tab active" onclick="showScreen('clients')"><span class="tab-icon"><svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg></span>Clients</div>
    <div class="tab" onclick="showScreen('sessions')"><span class="tab-icon"><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z"/></svg></span>Sessions</div>
    <div class="tab" onclick="showScreen('business')"><span class="tab-icon"><svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg></span>Business</div>
    <div class="tab" onclick="showScreen('billing')"><span class="tab-icon"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg></span>Billing</div>
  </div>

  <!-- Log Workout Modal -->
  <div id="log-modal" class="modal">
    <div class="modal-content modal-full">
      <div class="modal-header"><span onclick="closeLogModal()">✕</span><span class="modal-title">LOG WORKOUT</span><span onclick="saveWorkoutLog()" style="color:#4169E1">Save</span></div>
      <div class="modal-body">
        <h2 id="log-workout-name" style="font-size:20px;margin-bottom:8px;"></h2>
        <div class="bio-row" style="margin-bottom:20px;">
          <div class="bio-item"><span class="bio-label">Recovery</span><span class="bio-value" id="log-recovery">--</span></div>
          <div class="bio-item"><span class="bio-label">HRV</span><span class="bio-value" id="log-hrv">--</span></div>
        </div>
        <div id="log-exercises"></div>
        <div class="card" style="margin-top:20px;background:#0a0a0a;">
          <div class="card-header">POST-WORKOUT SYNC</div>
          <p style="font-size:12px;color:#666;margin-bottom:12px;">Biometrics will auto-sync after saving.</p>
          <div class="bio-row">
            <div class="bio-item"><span class="bio-label">Strain</span><span class="bio-value" id="log-strain">--</span></div>
            <div class="bio-item"><span class="bio-label">Avg HR</span><span class="bio-value" id="log-hr">--</span></div>
            <div class="bio-item"><span class="bio-label">Calories</span><span class="bio-value" id="log-cal">--</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Workout Modal -->
  <div id="create-modal" class="modal">
    <div class="modal-content modal-full">
      <div class="modal-header"><span onclick="closeCreateModal()">✕</span><span class="modal-title">CREATE WORKOUT</span><span onclick="saveScheduledWorkout()" style="color:#4169E1">Save</span></div>
      <div class="modal-body">
        <label class="input-label">WORKOUT NAME</label>
        <input type="text" id="create-name" class="input" placeholder="e.g., Push Day A">
        <label class="input-label">SCHEDULED DATE</label>
        <input type="date" id="create-date" class="input">
        <label class="input-label">NOTES FOR CLIENT</label>
        <textarea id="create-notes" class="input" rows="2" placeholder="Focus on form..."></textarea>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:24px;">
          <label class="input-label" style="margin:0;">EXERCISES</label>
          <button class="add-exercise-btn" onclick="addCreateExercise()">+ Add</button>
        </div>
        <div id="create-exercises"></div>
      </div>
    </div>
  </div>

  <!-- View Modal -->
  <div id="view-modal" class="modal">
    <div class="modal-content modal-full">
      <div class="modal-header"><span onclick="closeViewModal()">✕</span><span class="modal-title">WORKOUT DETAILS</span><span></span></div>
      <div class="modal-body" id="view-content"></div>
    </div>
  </div>

  <!-- Messages Modal -->
  <div id="messages-modal" class="modal">
    <div class="modal-content modal-full">
      <div class="modal-header"><span onclick="closeMessages()">✕</span><span class="modal-title">MESSAGES</span><span></span></div>
      <div class="chat-container">
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input-row">
          <input type="text" class="chat-input" id="chat-input" placeholder="Type a message...">
          <button class="chat-send" onclick="sendMessage()"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Session Detail Modal -->
  <div id="session-modal" class="modal">
    <div class="modal-content modal-full">
      <div class="modal-header"><span onclick="closeSessionModal()">✕</span><span class="modal-title">SESSION DETAILS</span><span></span></div>
      <div class="modal-body" id="session-content"></div>
    </div>
  </div>

  <!-- Labs Modal (Trainer Upload) -->
  <div id="labs-modal" class="modal">
    <div class="modal-content modal-full">
      <div class="modal-header"><span onclick="closeLabsModal()">✕</span><span class="modal-title">UPLOAD LAB RESULTS</span><span onclick="saveLabResults()" style="color:#4169E1">Save</span></div>
      <div class="modal-body">
        <label class="input-label">CLIENT</label>
        <select id="lab-client" class="input"><option value="demo">Sarah Johnson</option><option value="c2">Mike Chen</option><option value="c3">Emma Davis</option></select>
        <label class="input-label">TEST DATE</label>
        <input type="date" id="lab-date" class="input">
        <label class="input-label">LAB PROVIDER</label>
        <input type="text" id="lab-provider" class="input" placeholder="e.g., Quest Diagnostics">
        
        <div class="card-header" style="margin-top:24px;">COMPLETE BLOOD COUNT (CBC)</div>
        <div class="lab-inputs">
          <div class="lab-input"><label>WBC</label><input type="number" id="lab-wbc" placeholder="K/uL" step="0.1"></div>
          <div class="lab-input"><label>RBC</label><input type="number" id="lab-rbc" placeholder="M/uL" step="0.1"></div>
          <div class="lab-input"><label>Hemoglobin</label><input type="number" id="lab-hemoglobin" placeholder="g/dL" step="0.1"></div>
          <div class="lab-input"><label>Hematocrit</label><input type="number" id="lab-hematocrit" placeholder="%" step="0.1"></div>
          <div class="lab-input"><label>Platelets</label><input type="number" id="lab-platelets" placeholder="K/uL"></div>
        </div>
        
        <div class="card-header" style="margin-top:24px;">METABOLIC PANEL</div>
        <div class="lab-inputs">
          <div class="lab-input"><label>Glucose</label><input type="number" id="lab-glucose" placeholder="mg/dL"></div>
          <div class="lab-input"><label>HbA1c</label><input type="number" id="lab-a1c" placeholder="%" step="0.1"></div>
          <div class="lab-input"><label>Creatinine</label><input type="number" id="lab-creatinine" placeholder="mg/dL" step="0.1"></div>
          <div class="lab-input"><label>BUN</label><input type="number" id="lab-bun" placeholder="mg/dL"></div>
          <div class="lab-input"><label>eGFR</label><input type="number" id="lab-egfr" placeholder="mL/min"></div>
          <div class="lab-input"><label>Sodium</label><input type="number" id="lab-sodium" placeholder="mEq/L"></div>
          <div class="lab-input"><label>Potassium</label><input type="number" id="lab-potassium" placeholder="mEq/L" step="0.1"></div>
        </div>
        
        <div class="card-header" style="margin-top:24px;">LIPID PANEL</div>
        <div class="lab-inputs">
          <div class="lab-input"><label>Total Cholesterol</label><input type="number" id="lab-cholesterol" placeholder="mg/dL"></div>
          <div class="lab-input"><label>LDL</label><input type="number" id="lab-ldl" placeholder="mg/dL"></div>
          <div class="lab-input"><label>HDL</label><input type="number" id="lab-hdl" placeholder="mg/dL"></div>
          <div class="lab-input"><label>Triglycerides</label><input type="number" id="lab-triglycerides" placeholder="mg/dL"></div>
        </div>
        
        <div class="card-header" style="margin-top:24px;">LIVER FUNCTION</div>
        <div class="lab-inputs">
          <div class="lab-input"><label>ALT</label><input type="number" id="lab-alt" placeholder="U/L"></div>
          <div class="lab-input"><label>AST</label><input type="number" id="lab-ast" placeholder="U/L"></div>
        </div>
        
        <div class="card-header" style="margin-top:24px;">OTHER MARKERS</div>
        <div class="lab-inputs">
          <div class="lab-input"><label>TSH</label><input type="number" id="lab-tsh" placeholder="mIU/L" step="0.01"></div>
          <div class="lab-input"><label>hs-CRP</label><input type="number" id="lab-crp" placeholder="mg/L" step="0.1"></div>
        </div>
        
        <p style="font-size:11px;color:#555;margin-top:20px;text-align:center;">Leave blank any values not on the panel</p>
      </div>
    </div>
  </div>
</div>

<style>
  .modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.95); z-index:100; }
  .modal.active { display:flex; justify-content:center; align-items:flex-end; }
  .modal-full { background:#000; width:100%; max-width:430px; height:100%; overflow-y:auto; }
  .modal-header { display:flex; justify-content:space-between; align-items:center; padding:16px 20px; border-bottom:1px solid #222; position:sticky; top:0; background:#000; z-index:10; }
  .modal-header span { font-size:18px; cursor:pointer; width:50px; }
  .modal-header span:last-child { text-align:right; }
  .modal-title { font-size:11px; font-weight:600; color:#888; letter-spacing:2px; }
  .modal-body { padding:20px; }
  .input-label { display:block; font-size:10px; color:#666; letter-spacing:1px; margin-bottom:8px; margin-top:20px; }
  .input { width:100%; padding:14px; background:#111; border:1px solid #333; border-radius:10px; color:#fff; font-size:16px; resize:none; }
  .input:focus { outline:none; border-color:#4169E1; }
  .bio-row { display:flex; gap:8px; }
  .bio-item { flex:1; background:#111; border:1px solid #222; border-radius:10px; padding:10px; text-align:center; }
  .bio-label { display:block; font-size:9px; color:#666; }
  .bio-value { display:block; font-size:16px; font-weight:600; margin-top:2px; color:#00ff88; }
  .add-exercise-btn { background:transparent; border:1px solid #4169E1; color:#4169E1; padding:8px 12px; border-radius:6px; font-size:11px; cursor:pointer; }
  .exercise-card { background:#111; border:1px solid #222; border-radius:12px; padding:14px; margin-top:12px; }
  .exercise-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .exercise-name-input { background:transparent; border:none; color:#fff; font-size:15px; font-weight:600; width:80%; }
  .exercise-name-input:focus { outline:none; }
  .remove-btn { color:#4169E1; cursor:pointer; font-size:16px; }
  .sets-header { display:flex; font-size:9px; color:#666; padding:6px 0; border-bottom:1px solid #222; }
  .sets-header span { flex:1; text-align:center; }
  .sets-header span:first-child { flex:0.4; }
  .set-row { display:flex; align-items:center; padding:6px 0; border-bottom:1px solid #1a1a1a; }
  .set-row span:first-child { flex:0.4; color:#666; font-size:11px; text-align:center; }
  .set-input { flex:1; background:#1a1a1a; border:none; border-radius:6px; padding:10px; color:#fff; text-align:center; font-size:14px; margin:0 3px; }
  .set-input:focus { outline:none; background:#222; }
  .set-input.actual { color:#00ff88; }
  .add-set-btn { width:100%; padding:8px; background:transparent; border:1px dashed #333; border-radius:6px; color:#555; font-size:11px; cursor:pointer; margin-top:8px; }
  .week-nav { display:flex; justify-content:space-between; align-items:center; padding:12px 0; margin-bottom:12px; }
  .week-nav span { cursor:pointer; font-size:18px; color:#666; }
  .week-nav span:nth-child(2) { font-size:14px; font-weight:600; color:#fff; }
  .calendar-day { background:#111; border:1px solid #222; border-radius:12px; padding:14px; margin-bottom:10px; }
  .calendar-day.today { border-color:#4169E1; }
  .calendar-day-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .calendar-day-name { font-size:12px; color:#888; }
  .calendar-day-date { font-size:11px; color:#555; }
  .calendar-workout { background:#1a1a1a; border-radius:8px; padding:12px; margin-top:8px; cursor:pointer; }
  .calendar-workout.completed { border-left:3px solid #00ff88; }
  .calendar-workout.scheduled { border-left:3px solid #4169E1; }
  .calendar-workout-name { font-weight:600; font-size:14px; }
  .calendar-workout-meta { font-size:11px; color:#666; margin-top:4px; }
  .calendar-empty { color:#444; font-size:12px; font-style:italic; }
  .revenue-summary { display:flex; justify-content:space-around; padding:8px 0; }
  .revenue-item { text-align:center; }
  .revenue-value { font-size:24px; font-weight:700; color:#00ff88; }
  .revenue-label { font-size:10px; color:#666; margin-top:4px; text-transform:uppercase; letter-spacing:1px; }
  .session-card { background:#111; border:1px solid #222; border-radius:12px; padding:16px; margin-bottom:10px; }
  .session-card.upcoming { border-left:3px solid #4169E1; }
  .session-card.today { border-left:3px solid #00ff88; background:#00ff8808; }
  .session-time { font-size:13px; font-weight:600; color:#4169E1; }
  .session-client { font-size:16px; font-weight:600; margin:6px 0 4px; }
  .session-details { display:flex; gap:16px; font-size:11px; color:#666; }
  .session-trainer { color:#888; }
  .session-location { color:#888; }
  .session-revenue { color:#00ff88; font-weight:600; }
  .session-reminder { background:#4169E120; border:1px solid #4169E140; border-radius:8px; padding:10px 14px; margin-bottom:12px; font-size:12px; color:#4169E1; display:flex; align-items:center; gap:10px; }
  .biz-stat-row { display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #222; font-size:13px; }
  .biz-stat-row:last-child { border-bottom:none; }
  .billing-row { display:flex; justify-content:space-between; align-items:center; padding:14px; background:#111; border:1px solid #222; border-radius:10px; margin-bottom:8px; }
  .trainer-revenue-card { background:#111; border:1px solid #222; border-radius:10px; padding:14px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; }
  .trainer-revenue-name { font-weight:600; font-size:14px; }
  .trainer-revenue-sessions { font-size:11px; color:#666; margin-top:2px; }
  .trainer-revenue-amount { font-size:18px; font-weight:700; color:#00ff88; }
  .cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; }
  .cal-header { font-size:10px; color:#666; text-align:center; padding:8px 0; }
  .cal-day { background:#111; border:1px solid #222; border-radius:8px; min-height:60px; padding:6px; cursor:pointer; }
  .cal-day.today { border-color:#4169E1; }
  .cal-day.other-month { opacity:0.4; }
  .cal-day-num { font-size:11px; color:#888; margin-bottom:4px; }
  .cal-day.today .cal-day-num { color:#4169E1; font-weight:600; }
  .cal-session-dot { width:6px; height:6px; border-radius:3px; background:#4169E1; display:inline-block; margin:1px; }
  .cal-session-count { font-size:10px; color:#4169E1; }
  .msg-btn { position:relative; cursor:pointer; color:#666; padding:8px; }
  .msg-btn:hover { color:#fff; }
  .msg-badge { position:absolute; top:2px; right:2px; background:#4169E1; color:#fff; font-size:9px; font-weight:600; padding:2px 5px; border-radius:10px; }
  .client-session-card { background:#111; border:1px solid #222; border-radius:10px; padding:14px; margin-bottom:8px; }
  .client-session-card.pending { border-color:#ffaa00; }
  .client-week-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }
  .client-week-day { background:#111; border:1px solid #222; border-radius:8px; padding:8px 4px; text-align:center; cursor:default; }
  .client-week-day.today { border-color:#4169E1; background:#4169E110; }
  .client-week-day.has-session { cursor:pointer; }
  .client-week-day-name { font-size:10px; color:#666; }
  .client-week-day-num { font-size:14px; font-weight:600; margin-top:2px; }
  .client-week-day.today .client-week-day-num { color:#4169E1; }
  .client-week-dot { width:6px; height:6px; border-radius:3px; background:#4169E1; margin:4px auto 0; }
  .client-session-mini { display:flex; align-items:center; gap:12px; background:#111; border:1px solid #222; border-radius:8px; padding:10px 12px; margin-bottom:6px; cursor:pointer; }
  .client-session-mini.pending { border-color:#ffaa00; }
  .client-session-mini-date { font-size:12px; color:#4169E1; font-weight:600; min-width:80px; }
  .client-session-mini-time { font-size:13px; font-weight:600; }
  .client-session-mini-trainer { font-size:12px; color:#888; flex:1; }
  .client-session-mini-badge { font-size:9px; color:#ffaa00; background:#ffaa0020; padding:3px 6px; border-radius:4px; }
  .session-actions { display:flex; gap:8px; margin-top:10px; }
  .session-action-btn { flex:1; padding:8px; border-radius:6px; font-size:11px; cursor:pointer; text-align:center; }
  .session-action-btn.change { background:#4169E120; border:1px solid #4169E1; color:#4169E1; }
  .session-action-btn.cancel { background:#ff6b6b20; border:1px solid #ff6b6b; color:#ff6b6b; }
  .chat-container { display:flex; flex-direction:column; height:calc(100vh - 120px); }
  .chat-messages { flex:1; overflow-y:auto; padding:16px; }
  .chat-msg { max-width:80%; padding:10px 14px; border-radius:16px; margin-bottom:8px; font-size:14px; }
  .chat-msg.sent { background:#4169E1; margin-left:auto; border-bottom-right-radius:4px; }
  .chat-msg.received { background:#222; border-bottom-left-radius:4px; }
  .chat-msg-time { font-size:10px; color:#666; margin-top:4px; }
  .chat-input-row { display:flex; gap:8px; padding:12px 16px; border-top:1px solid #222; background:#111; }
  .chat-input { flex:1; padding:12px; background:#1a1a1a; border:1px solid #333; border-radius:20px; color:#fff; font-size:14px; }
  .chat-send { width:44px; height:44px; border-radius:22px; background:#4169E1; border:none; color:#fff; cursor:pointer; }
</style>

<style>
  .time-toggle { display:flex; gap:8px; margin:12px 0; }
  .time-btn { flex:1; padding:10px; background:#111; border:1px solid #222; border-radius:8px; color:#666; font-size:12px; font-weight:600; cursor:pointer; }
  .time-btn.active { background:#4169E1; border-color:#4169E1; color:#fff; }
  .legend-section { margin-bottom:16px; }
  .legend-section-title { font-size:10px; font-weight:600; color:#555; letter-spacing:1px; margin-bottom:8px; padding-left:4px; }
  .legend-grid { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
  .legend-item { display:flex; align-items:center; gap:8px; padding:10px 12px; background:#111; border:1px solid #222; border-radius:8px; cursor:pointer; }
  .legend-item.active { border-color:#4169E1; background:#4169E115; }
  .legend-dot { width:8px; height:8px; border-radius:4px; flex-shrink:0; }
  .legend-text { font-size:11px; color:#666; }
  .legend-item.active .legend-text { color:#fff; }
  .client-card { background:#111; border:1px solid #222; border-radius:12px; padding:16px; margin-bottom:10px; cursor:pointer; display:flex; align-items:center; gap:14px; }
  .client-card-expanded { background:#111; border:1px solid #222; border-radius:12px; margin-bottom:10px; overflow:hidden; }
  .client-card-header { padding:16px; cursor:pointer; display:flex; align-items:center; gap:14px; }
  .client-card-header:hover { background:#1a1a1a; }
  .client-actions { display:flex; gap:8px; padding:0 16px 16px; }
  .client-action-btn { flex:1; padding:10px; background:#1a1a1a; border:1px solid #333; border-radius:8px; color:#fff; font-size:11px; cursor:pointer; text-align:center; }
  .client-action-btn:hover { background:#222; border-color:#4169E1; }
  .client-avatar { width:44px; height:44px; border-radius:22px; background:#4169E1; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:18px; }
  .client-name { font-weight:600; font-size:15px; }
  .client-meta { font-size:11px; color:#666; margin-top:2px; }
  .health-metric-row { display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #222; font-size:13px; }
  .health-metric-row:last-child { border-bottom:none; }
  .health-alert { background:#1a1a1a; border-radius:8px; padding:12px; margin-bottom:8px; display:flex; align-items:center; gap:10px; }
  .health-alert.warning { border-left:3px solid #ffaa00; }
  .health-alert.danger { border-left:3px solid #ff6b6b; }
  .health-alert-icon { font-size:18px; }
  .health-alert-text { font-size:12px; color:#ccc; }
  .macro-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; }
  .macro-item { background:#1a1a1a; border-radius:10px; padding:12px 8px; text-align:center; }
  .macro-value { font-size:18px; font-weight:700; }
  .macro-label { font-size:9px; color:#666; margin-top:2px; }
  .macro-item.protein .macro-value { color:#ffaa00; }
  .macro-item.carbs .macro-value { color:#00aaff; }
  .macro-item.fats .macro-value { color:#ff66aa; }
  .macro-item.calories .macro-value { color:#fff; }
  .nutrition-inputs { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px; }
  .nut-input label { display:block; font-size:10px; color:#666; margin-bottom:4px; }
  .nut-input input { width:100%; padding:10px; background:#1a1a1a; border:1px solid #333; border-radius:8px; color:#fff; font-size:14px; }
  .lab-inputs { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .lab-input label { display:block; font-size:10px; color:#666; margin-bottom:4px; }
  .lab-input input { width:100%; padding:10px; background:#1a1a1a; border:1px solid #333; border-radius:8px; color:#fff; font-size:14px; }
  .lab-card { background:#111; border:1px solid #222; border-radius:12px; padding:16px; margin-bottom:12px; }
  .lab-card-date { font-size:13px; color:#4169E1; font-weight:600; }
  .lab-card-provider { font-size:11px; color:#666; margin-top:2px; }
  .lab-metrics { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:12px; }
  .lab-metric { text-align:center; }
  .lab-metric-value { font-size:16px; font-weight:600; }
  .lab-metric-value.normal { color:#00ff88; }
  .lab-metric-value.warning { color:#ffaa00; }
  .lab-metric-value.high { color:#ff6b6b; }
  .lab-metric-label { font-size:9px; color:#666; margin-top:2px; }
  .lab-trends-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
  .lab-trend-item { display:flex; flex-direction:column; align-items:center; }
  .lab-trend-label { font-size:10px; color:#888; margin-bottom:4px; }
  .lab-trend-value { font-size:16px; font-weight:700; }
  .btn-small { padding:12px 20px; background:#4169E1; border:none; border-radius:8px; color:#fff; font-size:12px; font-weight:600; cursor:pointer; }
  .avatar { width:50px; height:50px; border-radius:25px; background:#4169E1; display:flex; align-items:center; justify-content:center; font-size:22px; font-weight:700; }
  .setting-row { padding:14px 0; border-bottom:1px solid #222; display:flex; justify-content:space-between; cursor:pointer; }
  .setting-row:last-child { border-bottom:none; }
  .source-status { color:#4169E1; font-size:12px; }
  .source-status.connected { color:#00ff88; }
  .btn-outline { width:100%; padding:14px; background:transparent; color:#4169E1; border:1px solid #333; border-radius:10px; font-size:13px; cursor:pointer; margin-top:20px; }
  .import-option { display:flex; align-items:center; padding:12px 0; border-bottom:1px solid #222; cursor:pointer; }
  .import-option:hover { background:#1a1a1a; margin:0 -18px; padding:12px 18px; }
  .import-option:last-of-type { border-bottom:none; }
  .scheduled-date { font-size:10px; color:#4169E1; }
</style>

<script>
let role = localStorage.getItem('fitsync_role') || 'client';
let completedWorkouts = JSON.parse(localStorage.getItem('fitsync_completed') || '[]');
let scheduledWorkouts = JSON.parse(localStorage.getItem('fitsync_scheduled') || '[]');
let biometrics = JSON.parse(localStorage.getItem('fitsync_biometrics') || '[]');
let nutritionTargets = JSON.parse(localStorage.getItem('fitsync_nutrition') || '{"protein":150,"carbs":200,"fats":60,"calories":2200}');
let sources = JSON.parse(localStorage.getItem('fitsync_sources') || '{}');
let activeMetrics = ['recovery', 'strain'];
let timeRange = '1M';
let currentWeekOffset = 0;
let builderWeekOffset = 0;
let selectedClient = 'demo';
let createExercises = [];
let currentLogWorkout = null;
let analyticsChart = null;

const clients = [
  { id: 'demo', name: 'Ari', email: 'ari@fitsync.app' },
  { id: 'john', name: 'John Smith', email: 'john@email.com' },
  { id: 'sarah', name: 'Sarah Johnson', email: 'sarah@email.com' }
];

const trainers = [
  { id: 'trainer1', name: 'Coach Mike', rate: 85 },
  { id: 'trainer2', name: 'Coach Lisa', rate: 75 },
  { id: 'trainer3', name: 'Coach Dan', rate: 80 }
];

const locations = ['Main Gym', 'Downtown Studio', 'Virtual/Zoom', 'Client Home'];

let sessions = JSON.parse(localStorage.getItem('fitsync_sessions') || '[]');
let calendarView = 'week';
let calendarOffset = 0;

const metricConfig = {
  recovery: { label: 'Recovery', color: '#00ff88', unit: '%' },
  strain: { label: 'Strain', color: '#4169E1', unit: '' },
  hrv: { label: 'HRV', color: '#00bfff', unit: 'ms' },
  sleep: { label: 'Sleep', color: '#aa66ff', unit: 'hrs' },
  restingHR: { label: 'Resting HR', color: '#ff6b6b', unit: 'bpm' },
  vo2max: { label: 'VO2 Max', color: '#ffd93d', unit: '' },
  bodyWeight: { label: 'Body Weight', color: '#c9c9c9', unit: 'lbs' },
  bodyFat: { label: 'Body Fat %', color: '#ff9f43', unit: '%' },
  squatPR: { label: 'Squat PR', color: '#00ff88', unit: 'lbs' },
  deadliftPR: { label: 'Deadlift PR', color: '#4169E1', unit: 'lbs' },
  benchPR: { label: 'Bench PR', color: '#ff6b6b', unit: 'lbs' },
  protein: { label: 'Protein', color: '#ffaa00', unit: 'g', hasTarget: true },
  carbs: { label: 'Carbs', color: '#00aaff', unit: 'g', hasTarget: true },
  fats: { label: 'Fats', color: '#ff66aa', unit: 'g', hasTarget: true },
  calories: { label: 'Calories', color: '#ffffff', unit: 'kcal', hasTarget: true },
  calorieCompliance: { label: 'Calorie Compliance', color: '#00ff88', unit: '%', isCompliance: true },
  proteinCompliance: { label: 'Protein Compliance', color: '#ffaa00', unit: '%', isCompliance: true }
};

function init() {
  generateDemoData();
  generateDemoSchedule();
  generateDemoSessions();
  initLabs(); // Ensure sample bloodwork data exists
  updateRole();
  updateUI();
}

function generateDemoData() {
  if (biometrics.length === 0) {
    const now = new Date();
    // Programmed targets (what trainer prescribed)
    const targets = { protein: 140, carbs: 180, fats: 55, calories: 1950 };
    
    // Starting values 6 months ago - changes VERY slowly over months
    // Current: Squat 225, Deadlift 265, Bench 115, Weight ~135, BF ~19%
    let squat = 205, deadlift = 240, bench = 100;
    let weight = 137.5, bf = 21.5;
    
    for (let i = 180; i >= 0; i--) {
      const date = new Date(now); date.setDate(date.getDate() - i);
      const monthsAgo = Math.floor(i / 30);
      
      // PRs change only every 4-6 weeks (very slow, realistic progression)
      if (i % 35 === 0 && i > 0) { 
        squat += Math.floor(2 + Math.random() * 3); // +2-5 lbs per month
        deadlift += Math.floor(3 + Math.random() * 4); // +3-7 lbs per month
        bench += Math.floor(1 + Math.random() * 2); // +1-3 lbs per month
      }
      squat = Math.min(squat, 225);
      deadlift = Math.min(deadlift, 265);
      bench = Math.min(bench, 115);
      
      // Body comp changes MONTHLY - very gradual recomp
      if (i % 30 === 0 && i > 0) { 
        weight += (Math.random() - 0.5) * 0.5; // +/- 0.25 lbs per month
        bf -= 0.3 + Math.random() * 0.2; // Slow fat loss ~0.3-0.5% per month
      }
      weight = Math.max(134, Math.min(138, weight));
      bf = Math.max(19, Math.min(22, bf));
      
      // Daily biometrics variation
      const dayOfWeek = date.getDay();
      const isRestDay = dayOfWeek === 0 || dayOfWeek === 3; // Sun, Wed rest
      const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
      const recoveryBase = isRestDay ? 75 : 62;
      const strainBase = isRestDay ? 5 : 11;
      
      // Nutrition compliance - varies by day, weekends harder
      // Some days hit targets, some days under, some over
      const complianceFactor = isWeekend ? 0.7 + Math.random() * 0.5 : 0.85 + Math.random() * 0.3;
      const proteinActual = Math.floor(targets.protein * (0.75 + Math.random() * 0.5)); // 75-125% of target
      const carbsActual = Math.floor(targets.carbs * complianceFactor);
      const fatsActual = Math.floor(targets.fats * (0.8 + Math.random() * 0.6));
      const caloriesActual = Math.floor(targets.calories * complianceFactor);
      
      biometrics.push({
        date: date.toISOString().split('T')[0],
        recovery: Math.floor(recoveryBase + Math.random() * 25),
        strain: +(strainBase + Math.random() * 6).toFixed(1),
        hrv: Math.floor(48 + Math.random() * 30),
        sleep: +(6.5 + Math.random() * 2).toFixed(1),
        restingHR: Math.floor(52 + Math.random() * 8),
        vo2max: +(39 + Math.random() * 4).toFixed(1),
        bodyWeight: +weight.toFixed(1),
        bodyFat: +bf.toFixed(1),
        squatPR: squat, 
        deadliftPR: deadlift, 
        benchPR: bench,
        // Actual intake
        protein: proteinActual,
        carbs: carbsActual,
        fats: fatsActual,
        calories: caloriesActual,
        // Targets (for compliance calculation)
        proteinTarget: targets.protein,
        carbsTarget: targets.carbs,
        fatsTarget: targets.fats,
        caloriesTarget: targets.calories
      });
    }
    localStorage.setItem('fitsync_biometrics', JSON.stringify(biometrics));
  }
}

function generateDemoSchedule() {
  if (scheduledWorkouts.length === 0) {
    // Realistic working weights for woman with 225 squat, 265 deadlift, 115 bench
    const templates = [
      { name: 'Upper Push', exercises: [
        { name: 'Bench Press', sets: [{w:75,r:10},{w:85,r:8},{w:95,r:6},{w:105,r:4}] }, 
        { name: 'DB Shoulder Press', sets: [{w:25,r:12},{w:30,r:10},{w:35,r:8}] },
        { name: 'Tricep Pushdown', sets: [{w:40,r:12},{w:50,r:10}] }
      ]},
      { name: 'Lower - Deadlift', exercises: [
        { name: 'Deadlift', sets: [{w:185,r:6},{w:215,r:4},{w:235,r:3},{w:250,r:2}] }, 
        { name: 'Romanian DL', sets: [{w:135,r:10},{w:155,r:8}] },
        { name: 'Leg Curl', sets: [{w:70,r:12},{w:80,r:10}] }
      ]},
      { name: 'Upper Pull', exercises: [
        { name: 'Barbell Row', sets: [{w:85,r:10},{w:95,r:8},{w:105,r:6}] },
        { name: 'Lat Pulldown', sets: [{w:90,r:12},{w:100,r:10}] },
        { name: 'Face Pulls', sets: [{w:40,r:15},{w:50,r:12}] }
      ]},
      { name: 'Lower - Squat', exercises: [
        { name: 'Back Squat', sets: [{w:155,r:8},{w:175,r:6},{w:195,r:4},{w:210,r:3}] }, 
        { name: 'Bulgarian Split Squat', sets: [{w:35,r:10},{w:40,r:8}] },
        { name: 'Leg Extension', sets: [{w:80,r:12},{w:90,r:10}] }
      ]}
    ];
    const now = new Date();
    let templateIdx = 0;
    for (let i = -7; i < 28; i++) {
      const date = new Date(now); date.setDate(date.getDate() + i);
      const dayOfWeek = date.getDay();
      // Train Mon, Tue, Thu, Fri (4-day upper/lower split)
      if (dayOfWeek === 0 || dayOfWeek === 3 || dayOfWeek === 6) continue; // Skip Sun, Wed, Sat
      const t = templates[templateIdx % templates.length];
      templateIdx++;
      scheduledWorkouts.push({ 
        id: 'sched_' + Date.now() + '_' + i, 
        clientId: 'demo', 
        date: date.toISOString().split('T')[0], 
        name: t.name, 
        exercises: JSON.parse(JSON.stringify(t.exercises)), 
        notes: 'RPE 7-8. Focus on controlled tempo.' 
      });
    }
    localStorage.setItem('fitsync_scheduled', JSON.stringify(scheduledWorkouts));
  }
}

function generateDemoSessions() {
  if (sessions.length === 0) {
    const now = new Date();
    const times = ['09:00', '10:30', '12:00', '14:00', '16:00', '17:30'];
    
    // Generate sessions for next 14 days
    for (let i = 0; i < 14; i++) {
      const date = new Date(now); date.setDate(date.getDate() + i);
      const dateStr = date.toISOString().split('T')[0];
      
      // 2-4 sessions per day
      const numSessions = 2 + Math.floor(Math.random() * 3);
      const usedTimes = [];
      
      for (let j = 0; j < numSessions; j++) {
        let time;
        do { time = times[Math.floor(Math.random() * times.length)]; } while (usedTimes.includes(time));
        usedTimes.push(time);
        
        const client = clients[Math.floor(Math.random() * clients.length)];
        const trainer = trainers[Math.floor(Math.random() * trainers.length)];
        const location = locations[Math.floor(Math.random() * locations.length)];
        
        sessions.push({
          id: 'sess_' + Date.now() + '_' + i + '_' + j,
          clientId: client.id,
          clientName: client.name,
          trainerId: trainer.id,
          trainerName: trainer.name,
          date: dateStr,
          time,
          location,
          rate: trainer.rate,
          status: 'scheduled'
        });
      }
    }
    localStorage.setItem('fitsync_sessions', JSON.stringify(sessions));
  }
}
</script>

<script>
function toggleRole() { role = role === 'client' ? 'trainer' : 'client'; localStorage.setItem('fitsync_role', role); updateRole(); }

function updateRole() {
  const badge = document.getElementById('role-badge');
  badge.textContent = role.toUpperCase();
  badge.classList.toggle('trainer', role === 'trainer');
  document.getElementById('client-tabs').style.display = role === 'client' ? 'flex' : 'none';
  document.getElementById('trainer-tabs').style.display = role === 'trainer' ? 'flex' : 'none';
  document.getElementById('fab-btn').style.display = role === 'trainer' ? 'block' : 'none';
  showScreen(role === 'client' ? 'dashboard' : 'clients');
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (event?.target) event.target.closest('.tab')?.classList.add('active');
  if (id === 'analytics') renderAnalytics();
  if (id === 'program') { renderClientSessionsCalendar(); renderProgramCalendar(); }
  if (id === 'labs') renderLabs();
  if (id === 'clients') renderClients();
  if (id === 'builder') renderBuilderCalendar();
  if (id === 'sessions') renderTrainerSessions();
  if (id === 'my-sessions') renderClientSessions();
  if (id === 'business') renderBusinessDashboard();
  if (id === 'billing') renderBilling();
  updateUI();
}

function handleFab() { if (role === 'trainer') openCreateModal(); }

function updateUI() {
  const today = biometrics[biometrics.length - 1] || {};
  document.getElementById('recovery-score').textContent = today.recovery ? today.recovery + '%' : '--';
  document.getElementById('recovery-score').className = 'stat-value ' + (today.recovery >= 67 ? 'recovery-high' : today.recovery >= 34 ? 'recovery-med' : 'recovery-low');
  document.getElementById('hrv-score').textContent = today.hrv || '--';
  document.getElementById('strain-score').textContent = today.strain || '--';
  
  document.getElementById('nutrition-targets').innerHTML = `
    <div class="macro-item protein"><div class="macro-value">${nutritionTargets.protein}g</div><div class="macro-label">PROTEIN</div></div>
    <div class="macro-item carbs"><div class="macro-value">${nutritionTargets.carbs}g</div><div class="macro-label">CARBS</div></div>
    <div class="macro-item fats"><div class="macro-value">${nutritionTargets.fats}g</div><div class="macro-label">FATS</div></div>
    <div class="macro-item calories"><div class="macro-value">${nutritionTargets.calories}</div><div class="macro-label">KCAL</div></div>`;
  
  const todayStr = new Date().toISOString().split('T')[0];
  document.getElementById('today-date').textContent = new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
  const todayWorkout = scheduledWorkouts.find(w => w.date === todayStr && w.clientId === 'demo');
  const todayCompleted = completedWorkouts.find(w => w.scheduledId && scheduledWorkouts.find(s => s.id === w.scheduledId)?.date === todayStr);
  
  if (todayCompleted) {
    document.getElementById('todays-workout').innerHTML = `<div class="calendar-workout completed" onclick="viewCompleted('${todayCompleted.id}')"><div class="calendar-workout-name">✓ ${todayCompleted.name}</div><div class="calendar-workout-meta">Completed • Strain: ${todayCompleted.strain || '--'}</div></div>`;
  } else if (todayWorkout) {
    document.getElementById('todays-workout').innerHTML = `<div class="calendar-workout scheduled" onclick="openLogModal('${todayWorkout.id}')"><div class="calendar-workout-name">${todayWorkout.name}</div><div class="calendar-workout-meta">${todayWorkout.exercises.length} exercises • Tap to log</div></div>`;
  } else {
    document.getElementById('todays-workout').innerHTML = '<div class="calendar-empty">Rest day</div>';
  }
  
  const upcoming = scheduledWorkouts.filter(w => w.date > todayStr && w.clientId === 'demo').sort((a,b) => a.date.localeCompare(b.date)).slice(0, 3);
  document.getElementById('upcoming-workouts').innerHTML = upcoming.length ? upcoming.map(w => `<div class="calendar-workout scheduled" style="margin-top:8px;"><div class="calendar-workout-name">${w.name}</div><div class="calendar-workout-meta">${new Date(w.date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</div></div>`).join('') : '<div class="calendar-empty">No upcoming workouts</div>';
  
  ['whoop', 'apple', 'garmin', 'oura', 'fatsecret'].forEach(s => {
    const el = document.getElementById(s + '-status');
    if (el) { el.textContent = sources[s] ? 'Connected' : 'Connect'; el.classList.toggle('connected', sources[s]); }
  });
}

function getWeekDates(offset = 0) {
  const now = new Date();
  const start = new Date(now); start.setDate(now.getDate() - now.getDay() + (offset * 7));
  return Array.from({length: 7}, (_, i) => { const d = new Date(start); d.setDate(start.getDate() + i); return d; });
}

function prevWeek() { currentWeekOffset--; renderProgramCalendar(); }
function nextWeek() { currentWeekOffset++; renderProgramCalendar(); }

function renderProgramCalendar() {
  const days = getWeekDates(currentWeekOffset);
  const todayStr = new Date().toISOString().split('T')[0];
  document.getElementById('week-label').textContent = currentWeekOffset === 0 ? 'This Week' : days[0].toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' - ' + days[6].toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  document.getElementById('program-calendar').innerHTML = days.map(d => {
    const dateStr = d.toISOString().split('T')[0];
    const scheduled = scheduledWorkouts.find(w => w.date === dateStr && w.clientId === 'demo');
    const completed = completedWorkouts.find(w => w.scheduledId && scheduledWorkouts.find(s => s.id === w.scheduledId)?.date === dateStr);
    return `<div class="calendar-day ${dateStr === todayStr ? 'today' : ''}"><div class="calendar-day-header"><span class="calendar-day-name">${d.toLocaleDateString('en-US', { weekday: 'short' })}</span><span class="calendar-day-date">${d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span></div>${completed ? `<div class="calendar-workout completed" onclick="viewCompleted('${completed.id}')"><div class="calendar-workout-name">✓ ${completed.name}</div></div>` : scheduled ? `<div class="calendar-workout scheduled" onclick="openLogModal('${scheduled.id}')"><div class="calendar-workout-name">${scheduled.name}</div></div>` : '<div class="calendar-empty">Rest</div>'}</div>`;
  }).join('');
}
</script>

<script>
function openLogModal(scheduledId) {
  const workout = scheduledWorkouts.find(w => w.id === scheduledId);
  if (!workout) return;
  currentLogWorkout = JSON.parse(JSON.stringify(workout));
  const today = biometrics[biometrics.length - 1] || {};
  document.getElementById('log-workout-name').textContent = workout.name;
  document.getElementById('log-recovery').textContent = today.recovery ? today.recovery + '%' : '--';
  document.getElementById('log-hrv').textContent = today.hrv ? today.hrv + 'ms' : '--';
  document.getElementById('log-strain').textContent = '--';
  document.getElementById('log-hr').textContent = '--';
  document.getElementById('log-cal').textContent = '--';
  renderLogExercises();
  document.getElementById('log-modal').classList.add('active');
}
function closeLogModal() { document.getElementById('log-modal').classList.remove('active'); currentLogWorkout = null; }

function renderLogExercises() {
  document.getElementById('log-exercises').innerHTML = currentLogWorkout.exercises.map((ex, exIdx) => `
    <div class="exercise-card"><div class="exercise-header"><span style="font-weight:600;font-size:15px;">${ex.name}</span></div>
    <div class="sets-header"><span>SET</span><span>TARGET</span><span>ACTUAL LBS</span><span>ACTUAL REPS</span></div>
    ${ex.sets.map((set, setIdx) => `<div class="set-row"><span>${setIdx + 1}</span><span style="flex:1;text-align:center;color:#666;font-size:12px;">${set.w || 0} × ${set.r || 0}</span><input type="number" class="set-input actual" placeholder="${set.w || 0}" data-ex="${exIdx}" data-set="${setIdx}" data-field="actualW"><input type="number" class="set-input actual" placeholder="${set.r || 0}" data-ex="${exIdx}" data-set="${setIdx}" data-field="actualR"></div>`).join('')}</div>`).join('');
}

function saveWorkoutLog() {
  if (!currentLogWorkout) return;
  document.querySelectorAll('#log-exercises .set-input').forEach(input => {
    const exIdx = parseInt(input.dataset.ex), setIdx = parseInt(input.dataset.set), field = input.dataset.field;
    const val = parseFloat(input.value) || parseFloat(input.placeholder) || 0;
    if (field === 'actualW') currentLogWorkout.exercises[exIdx].sets[setIdx].actualW = val;
    if (field === 'actualR') currentLogWorkout.exercises[exIdx].sets[setIdx].actualR = val;
  });
  const totalVolume = currentLogWorkout.exercises.reduce((sum, ex) => sum + ex.sets.reduce((s, set) => s + (set.actualW || set.w || 0) * (set.actualR || set.r || 0), 0), 0);
  const today = biometrics[biometrics.length - 1] || {};
  const strain = +(8 + Math.random() * 10).toFixed(1), avgHR = Math.floor(120 + Math.random() * 40), calories = Math.floor(200 + Math.random() * 300);
  completedWorkouts.unshift({ id: 'comp_' + Date.now(), scheduledId: currentLogWorkout.id, name: currentLogWorkout.name, exercises: currentLogWorkout.exercises, date: new Date().toISOString(), recovery: today.recovery, hrv: today.hrv, strain, avgHR, calories, totalVolume });
  localStorage.setItem('fitsync_completed', JSON.stringify(completedWorkouts));
  closeLogModal(); updateUI(); renderProgramCalendar();
  alert(`Workout logged!\nStrain: ${strain}\nAvg HR: ${avgHR} bpm\nCalories: ${calories}`);
}

function viewCompleted(id) {
  const w = completedWorkouts.find(x => x.id === id);
  if (!w) return;
  document.getElementById('view-content').innerHTML = `<h2 style="font-size:22px;font-weight:700;margin-bottom:6px;">${w.name}</h2><p style="color:#666;font-size:12px;margin-bottom:20px;">${new Date(w.date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</p><div class="bio-row" style="margin-bottom:20px;"><div class="bio-item"><span class="bio-label">Recovery</span><span class="bio-value" style="color:#00ff88">${w.recovery || '--'}%</span></div><div class="bio-item"><span class="bio-label">HRV</span><span class="bio-value" style="color:#00bfff">${w.hrv || '--'}</span></div><div class="bio-item"><span class="bio-label">Strain</span><span class="bio-value" style="color:#4169E1">${w.strain || '--'}</span></div><div class="bio-item"><span class="bio-label">Avg HR</span><span class="bio-value" style="color:#ff66aa">${w.avgHR || '--'}</span></div></div><div class="card-header">EXERCISES</div>${w.exercises.map(ex => `<div class="exercise-card" style="margin-bottom:10px;"><div style="font-weight:600;font-size:14px;margin-bottom:10px;">${ex.name}</div>${ex.sets.map((s, i) => `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #1a1a1a;font-size:13px;"><span style="color:#666">Set ${i+1}</span><span><span style="color:#666">${s.w}×${s.r}</span> → <span style="color:#00ff88">${s.actualW || s.w} × ${s.actualR || s.r}</span></span></div>`).join('')}</div>`).join('')}<div style="margin-top:20px;padding:16px;background:#111;border-radius:12px;text-align:center;"><div style="font-size:11px;color:#666;">TOTAL VOLUME</div><div style="font-size:28px;font-weight:700;color:#4169E1;">${w.totalVolume?.toLocaleString() || 0} lbs</div></div>`;
  document.getElementById('view-modal').classList.add('active');
}
function closeViewModal() { document.getElementById('view-modal').classList.remove('active'); }

function renderClients() {
  document.getElementById('clients-list').innerHTML = clients.map(c => {
    const compliance = calculateClientCompliance(c.id);
    const complianceColor = compliance >= 85 ? '#00ff88' : compliance >= 70 ? '#ffaa00' : '#ff6b6b';
    return `
      <div class="client-card-expanded">
        <div class="client-card-header" onclick="toggleClientExpand('${c.id}')">
          <div class="client-avatar">${c.name[0]}</div>
          <div style="flex:1;">
            <div class="client-name">${c.name}</div>
            <div class="client-meta">${c.email}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:18px;font-weight:700;color:${complianceColor}">${compliance}%</div>
            <div style="font-size:9px;color:#666;">COMPLIANCE</div>
          </div>
        </div>
        <div class="client-actions" id="client-actions-${c.id}" style="display:none;">
          <button class="client-action-btn" onclick="openClientHealth('${c.id}')">📊 Health Dashboard</button>
          <button class="client-action-btn" onclick="selectClient('${c.id}')">📝 Program Builder</button>
        </div>
      </div>`;
  }).join('');
}

function toggleClientExpand(id) {
  const el = document.getElementById('client-actions-' + id);
  el.style.display = el.style.display === 'none' ? 'flex' : 'none';
}

function calculateClientCompliance(clientId) {
  // Calculate 7-day compliance score
  const last7 = biometrics.slice(-7);
  if (last7.length === 0) return 0;
  
  let scores = [];
  last7.forEach(d => {
    // Calorie compliance (within 10% of target)
    if (d.caloriesTarget && d.calories) {
      const calPct = (d.calories / d.caloriesTarget) * 100;
      scores.push(calPct >= 90 && calPct <= 110 ? 100 : Math.max(0, 100 - Math.abs(100 - calPct)));
    }
    // Protein compliance (within 15% of target)
    if (d.proteinTarget && d.protein) {
      const protPct = (d.protein / d.proteinTarget) * 100;
      scores.push(protPct >= 85 ? 100 : protPct);
    }
    // Sleep compliance (7+ hours = 100%)
    if (d.sleep) {
      scores.push(d.sleep >= 7 ? 100 : (d.sleep / 7) * 100);
    }
  });
  
  return scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
}

function openClientHealth(id) {
  selectedClient = id;
  const client = clients.find(c => c.id === id);
  document.getElementById('health-client-name').textContent = client.name;
  renderClientHealthDashboard();
  showScreen('client-health');
}

function renderClientHealthDashboard() {
  const last7 = biometrics.slice(-7);
  const last30 = biometrics.slice(-30);
  const latest = biometrics[biometrics.length - 1] || {};
  
  // Calculate compliance score
  const compliance = calculateClientCompliance(selectedClient);
  const complianceColor = compliance >= 85 ? '#00ff88' : compliance >= 70 ? '#ffaa00' : '#ff6b6b';
  const complianceLabel = compliance >= 85 ? 'Excellent' : compliance >= 70 ? 'Good' : compliance >= 50 ? 'Needs Work' : 'At Risk';
  
  document.getElementById('health-compliance-score').textContent = compliance + '%';
  document.getElementById('health-compliance-score').style.color = complianceColor;
  document.getElementById('health-compliance-label').textContent = complianceLabel;
  document.getElementById('health-compliance-label').style.color = complianceColor;
  
  // Calculate 7-day metrics
  const avgSleep = last7.length ? (last7.reduce((s, d) => s + (d.sleep || 0), 0) / last7.length).toFixed(1) : '--';
  const avgRecovery = last7.length ? Math.round(last7.reduce((s, d) => s + (d.recovery || 0), 0) / last7.length) : '--';
  
  // Calorie compliance (days within 10% of target)
  const calCompDays = last7.filter(d => {
    if (!d.caloriesTarget || !d.calories) return false;
    const pct = (d.calories / d.caloriesTarget) * 100;
    return pct >= 90 && pct <= 110;
  }).length;
  
  // Protein compliance (days hitting 85%+ of target)
  const protCompDays = last7.filter(d => {
    if (!d.proteinTarget || !d.protein) return false;
    return (d.protein / d.proteinTarget) >= 0.85;
  }).length;
  
  // Workouts completed (count scheduled workouts in last 7 days that have completedWorkouts)
  const workoutsCompleted = completedWorkouts.filter(w => {
    const wDate = new Date(w.date);
    const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7);
    return wDate >= weekAgo;
  }).length;
  
  document.getElementById('health-cal-compliance').innerHTML = `<span style="color:${calCompDays >= 5 ? '#00ff88' : calCompDays >= 3 ? '#ffaa00' : '#ff6b6b'}">${calCompDays}/7 days</span>`;
  document.getElementById('health-protein-compliance').innerHTML = `<span style="color:${protCompDays >= 5 ? '#00ff88' : protCompDays >= 3 ? '#ffaa00' : '#ff6b6b'}">${protCompDays}/7 days</span>`;
  document.getElementById('health-sleep-avg').innerHTML = `<span style="color:${avgSleep >= 7 ? '#00ff88' : avgSleep >= 6 ? '#ffaa00' : '#ff6b6b'}">${avgSleep} hrs</span>`;
  document.getElementById('health-recovery-avg').innerHTML = `<span style="color:${avgRecovery >= 70 ? '#00ff88' : avgRecovery >= 50 ? '#ffaa00' : '#ff6b6b'}">${avgRecovery}%</span>`;
  document.getElementById('health-workouts').innerHTML = `<span style="color:#4169E1">${workoutsCompleted}</span>`;
  
  // Recent biometrics
  document.getElementById('health-weight').textContent = latest.bodyWeight ? latest.bodyWeight + ' lbs' : '--';
  document.getElementById('health-bf').textContent = latest.bodyFat ? latest.bodyFat + '%' : '--';
  document.getElementById('health-squat').textContent = latest.squatPR ? latest.squatPR + ' lbs' : '--';
  document.getElementById('health-deadlift').textContent = latest.deadliftPR ? latest.deadliftPR + ' lbs' : '--';
  document.getElementById('health-bench').textContent = latest.benchPR ? latest.benchPR + ' lbs' : '--';
  
  // Generate alerts
  let alerts = [];
  if (avgSleep < 6.5) alerts.push({ type: 'danger', icon: '😴', text: 'Sleep averaging below 6.5 hours - may impact recovery' });
  else if (avgSleep < 7) alerts.push({ type: 'warning', icon: '😴', text: 'Sleep slightly below target (7+ hrs recommended)' });
  
  if (calCompDays < 3) alerts.push({ type: 'danger', icon: '🍽️', text: 'Calorie compliance low - only ' + calCompDays + '/7 days on target' });
  else if (calCompDays < 5) alerts.push({ type: 'warning', icon: '🍽️', text: 'Calorie compliance could improve - ' + calCompDays + '/7 days on target' });
  
  if (protCompDays < 3) alerts.push({ type: 'danger', icon: '🥩', text: 'Protein intake low - only ' + protCompDays + '/7 days hitting target' });
  else if (protCompDays < 5) alerts.push({ type: 'warning', icon: '🥩', text: 'Protein could be more consistent - ' + protCompDays + '/7 days on target' });
  
  if (avgRecovery < 50) alerts.push({ type: 'danger', icon: '⚡', text: 'Recovery scores low - consider deload or extra rest' });
  else if (avgRecovery < 65) alerts.push({ type: 'warning', icon: '⚡', text: 'Recovery trending down - monitor closely' });
  
  if (alerts.length === 0) {
    alerts.push({ type: 'success', icon: '✅', text: 'All metrics looking good! Keep it up.' });
  }
  
  document.getElementById('health-alerts').innerHTML = alerts.map(a => 
    `<div class="health-alert ${a.type}"><span class="health-alert-icon">${a.icon}</span><span class="health-alert-text">${a.text}</span></div>`
  ).join('');
}

function selectClient(id) {
  selectedClient = id;
  const client = clients.find(c => c.id === id);
  document.getElementById('builder-client-name').textContent = '• ' + client.name;
  document.getElementById('nut-protein').value = nutritionTargets.protein;
  document.getElementById('nut-carbs').value = nutritionTargets.carbs;
  document.getElementById('nut-fats').value = nutritionTargets.fats;
  document.getElementById('nut-calories').value = nutritionTargets.calories;
  showScreen('builder');
}

function builderPrevWeek() { builderWeekOffset--; renderBuilderCalendar(); }
function builderNextWeek() { builderWeekOffset++; renderBuilderCalendar(); }

function renderBuilderCalendar() {
  const days = getWeekDates(builderWeekOffset);
  document.getElementById('builder-week-label').textContent = builderWeekOffset === 0 ? 'This Week' : days[0].toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' - ' + days[6].toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  document.getElementById('builder-calendar').innerHTML = days.map(d => {
    const dateStr = d.toISOString().split('T')[0];
    const scheduled = scheduledWorkouts.filter(w => w.date === dateStr && w.clientId === selectedClient);
    return `<div class="calendar-day"><div class="calendar-day-header"><span class="calendar-day-name">${d.toLocaleDateString('en-US', { weekday: 'short' })}</span><span class="calendar-day-date">${d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span></div>${scheduled.map(w => `<div class="calendar-workout scheduled" onclick="editScheduledWorkout('${w.id}')"><div class="calendar-workout-name">${w.name}</div></div>`).join('')}<div class="add-set-btn" onclick="openCreateModalForDate('${dateStr}')">+ Add Workout</div></div>`;
  }).join('');
}

function saveNutritionTargets() {
  nutritionTargets = { protein: parseInt(document.getElementById('nut-protein').value) || 150, carbs: parseInt(document.getElementById('nut-carbs').value) || 200, fats: parseInt(document.getElementById('nut-fats').value) || 60, calories: parseInt(document.getElementById('nut-calories').value) || 2200 };
  localStorage.setItem('fitsync_nutrition', JSON.stringify(nutritionTargets));
  alert('Nutrition targets saved!');
}
</script>

<script>
function openCreateModal() { openCreateModalForDate(new Date().toISOString().split('T')[0]); }

function openCreateModalForDate(dateStr) {
  createExercises = [{ name: '', sets: [{ w: '', r: '' }] }];
  document.getElementById('create-name').value = '';
  document.getElementById('create-date').value = dateStr;
  document.getElementById('create-notes').value = '';
  renderCreateExercises();
  document.getElementById('create-modal').classList.add('active');
}
function closeCreateModal() { document.getElementById('create-modal').classList.remove('active'); }

function addCreateExercise() { createExercises.push({ name: '', sets: [{ w: '', r: '' }] }); renderCreateExercises(); }
function removeCreateExercise(idx) { createExercises.splice(idx, 1); renderCreateExercises(); }
function addCreateSet(exIdx) { createExercises[exIdx].sets.push({ w: '', r: '' }); renderCreateExercises(); }

function renderCreateExercises() {
  document.getElementById('create-exercises').innerHTML = createExercises.map((ex, exIdx) => `
    <div class="exercise-card"><div class="exercise-header"><input type="text" class="exercise-name-input" placeholder="Exercise name" value="${ex.name}" onchange="createExercises[${exIdx}].name=this.value"><span class="remove-btn" onclick="removeCreateExercise(${exIdx})">✕</span></div>
    <div class="sets-header"><span>SET</span><span>WEIGHT</span><span>REPS</span></div>
    ${ex.sets.map((set, setIdx) => `<div class="set-row"><span>${setIdx + 1}</span><input type="number" class="set-input" placeholder="0" value="${set.w}" onchange="createExercises[${exIdx}].sets[${setIdx}].w=this.value"><input type="number" class="set-input" placeholder="0" value="${set.r}" onchange="createExercises[${exIdx}].sets[${setIdx}].r=this.value"></div>`).join('')}
    <button class="add-set-btn" onclick="addCreateSet(${exIdx})">+ Add Set</button></div>`).join('');
}

function saveScheduledWorkout() {
  const name = document.getElementById('create-name').value, date = document.getElementById('create-date').value, notes = document.getElementById('create-notes').value;
  if (!name || !date) { alert('Please enter name and date'); return; }
  const validExercises = createExercises.filter(e => e.name).map(e => ({ name: e.name, sets: e.sets.filter(s => s.w || s.r).map(s => ({ w: parseInt(s.w) || 0, r: parseInt(s.r) || 0 })) }));
  if (validExercises.length === 0) { alert('Add at least one exercise'); return; }
  scheduledWorkouts.push({ id: 'sched_' + Date.now(), clientId: selectedClient, date, name, notes, exercises: validExercises });
  localStorage.setItem('fitsync_scheduled', JSON.stringify(scheduledWorkouts));
  closeCreateModal(); renderBuilderCalendar();
  alert('Workout scheduled!');
}

function editScheduledWorkout(id) {
  const w = scheduledWorkouts.find(x => x.id === id);
  if (!w) return;
  createExercises = JSON.parse(JSON.stringify(w.exercises));
  document.getElementById('create-name').value = w.name;
  document.getElementById('create-date').value = w.date;
  document.getElementById('create-notes').value = w.notes || '';
  renderCreateExercises();
  scheduledWorkouts = scheduledWorkouts.filter(x => x.id !== id);
  document.getElementById('create-modal').classList.add('active');
}

function setTimeRange(range) {
  timeRange = range;
  document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  renderAnalytics();
}

function toggleMetric(metric) {
  const idx = activeMetrics.indexOf(metric);
  if (idx >= 0) activeMetrics.splice(idx, 1);
  else if (activeMetrics.length < 5) activeMetrics.push(metric);
  else { alert('Maximum 5 metrics. Deselect one first.'); return; }
  renderAnalytics();
}

function renderAnalytics() {
  const days = timeRange === '1M' ? 30 : timeRange === '3M' ? 90 : 180;
  const data = biometrics.slice(-days);
  
  // Group metrics by category for legend
  const metricGroups = {
    'BIOMETRICS': ['recovery', 'strain', 'hrv', 'sleep', 'restingHR', 'vo2max'],
    'BODY COMPOSITION': ['bodyWeight', 'bodyFat'],
    'STRENGTH PRs': ['squatPR', 'deadliftPR', 'benchPR'],
    'NUTRITION': ['protein', 'carbs', 'fats', 'calories']
  };
  
  let legendHTML = '<p style="font-size:10px;color:#666;margin-bottom:12px;">Raw data with auto-scaled axes. Select up to 5 metrics.</p>';
  Object.entries(metricGroups).forEach(([groupName, metrics]) => {
    legendHTML += `<div class="legend-section"><div class="legend-section-title">${groupName}</div><div class="legend-grid">`;
    metrics.forEach(key => {
      const cfg = metricConfig[key];
      if (cfg) {
        legendHTML += `<div class="legend-item ${activeMetrics.includes(key) ? 'active' : ''}" onclick="toggleMetric('${key}')">
          <div class="legend-dot" style="background:${cfg.color}"></div>
          <span class="legend-text">${cfg.label}</span>
        </div>`;
      }
    });
    legendHTML += '</div></div>';
  });
  document.getElementById('legend-grid').innerHTML = legendHTML;
  
  const ctx = document.getElementById('analyticsChart').getContext('2d');
  if (analyticsChart) analyticsChart.destroy();
  
  // Build datasets with RAW data and individual Y-axes
  const metricStats = {};
  const scales = {
    x: { 
      grid: { color: '#1a1a1a' }, 
      ticks: { color: '#666', maxTicksLimit: 6, font: { size: 9 } } 
    }
  };
  
  const datasets = activeMetrics.map((metric, idx) => {
    const cfg = metricConfig[metric];
    const rawValues = data.map(d => parseFloat(d[metric]) || null);
    const validValues = rawValues.filter(v => v !== null && v > 0);
    
    // Get min/max for this metric
    const minVal = Math.min(...validValues);
    const maxVal = Math.max(...validValues);
    const avg = validValues.reduce((a,b) => a+b, 0) / validValues.length;
    
    // Store stats for raw data summary
    metricStats[metric] = { 
      min: minVal, max: maxVal, avg: avg.toFixed(1),
      start: validValues[0], end: validValues[validValues.length - 1],
      change: validValues.length > 1 ? (validValues[validValues.length - 1] - validValues[0]).toFixed(1) : 0
    };
    
    // Create Y-axis for this metric with padding for smoother lines
    const padding = (maxVal - minVal) * 0.1 || 1;
    const yAxisId = 'y' + (idx === 0 ? '' : idx);
    
    scales[yAxisId] = {
      type: 'linear',
      display: idx < 2, // Only show first 2 axes (left and right)
      position: idx === 0 ? 'left' : 'right',
      min: Math.floor(minVal - padding),
      max: Math.ceil(maxVal + padding),
      grid: { color: idx === 0 ? '#1a1a1a' : 'transparent' },
      ticks: { 
        color: cfg.color, 
        font: { size: 9 },
        maxTicksLimit: 5
      }
    };
    
    return {
      label: cfg.label,
      data: rawValues,
      borderColor: cfg.color,
      backgroundColor: cfg.color + '15',
      borderWidth: 2,
      pointRadius: 0,
      pointHoverRadius: 4,
      tension: 0.4, // Smoother curves
      fill: false,
      yAxisID: yAxisId,
      unit: cfg.unit
    };
  });
  
  analyticsChart = new Chart(ctx, {
    type: 'line',
    data: { 
      labels: data.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })), 
      datasets 
    },
    options: {
      responsive: true, 
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: { 
        legend: { display: false },
        tooltip: { 
          backgroundColor: '#111', 
          titleColor: '#fff',
          bodySpacing: 6,
          padding: 14,
          borderColor: '#333',
          borderWidth: 1,
          callbacks: { 
            title: (items) => items[0]?.label || '',
            label: (ctx) => `${ctx.dataset.label}: ${ctx.raw}${ctx.dataset.unit}`
          } 
        } 
      },
      scales: scales
    }
  });
  
  // Render raw data summary
  renderRawDataSummary(data, metricStats);
  
  // Render correlation insights
  renderCorrelationInsights(data);
}

function renderRawDataSummary(data, metricStats) {
  if (activeMetrics.length === 0) {
    document.getElementById('raw-data-summary').innerHTML = '<p style="font-size:11px;color:#555;text-align:center;">Select metrics above to see raw data</p>';
    return;
  }
  
  let html = '<table style="width:100%;font-size:11px;border-collapse:collapse;">';
  html += '<tr style="color:#666;border-bottom:1px solid #222;"><th style="text-align:left;padding:8px 4px;">Metric</th><th>Start</th><th>End</th><th>Change</th><th>Avg</th><th>Range</th></tr>';
  
  activeMetrics.forEach(metric => {
    const cfg = metricConfig[metric];
    const stats = metricStats[metric];
    const changeNum = parseFloat(stats.change);
    const changeColor = changeNum > 0 ? '#00ff88' : changeNum < 0 ? '#ff6b6b' : '#888';
    const changeSign = changeNum > 0 ? '+' : '';
    
    html += `<tr style="border-bottom:1px solid #1a1a1a;">
      <td style="padding:8px 4px;"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${cfg.color};margin-right:6px;"></span>${cfg.label}</td>
      <td style="text-align:center;color:#888;">${stats.start}${cfg.unit}</td>
      <td style="text-align:center;color:#fff;">${stats.end}${cfg.unit}</td>
      <td style="text-align:center;color:${changeColor};">${changeSign}${stats.change}${cfg.unit}</td>
      <td style="text-align:center;color:#888;">${stats.avg}${cfg.unit}</td>
      <td style="text-align:center;color:#555;">${stats.min}-${stats.max}</td>
    </tr>`;
  });
  
  html += '</table>';
  
  // Add compliance summary if nutrition metrics selected
  const nutritionMetrics = ['protein', 'carbs', 'fats', 'calories'].filter(m => activeMetrics.includes(m));
  if (nutritionMetrics.length > 0 && data.length > 0) {
    html += '<div style="margin-top:12px;padding-top:12px;border-top:1px solid #222;">';
    html += '<div style="font-size:10px;color:#666;margin-bottom:8px;letter-spacing:1px;">COMPLIANCE VS TARGET</div>';
    
    nutritionMetrics.forEach(metric => {
      const targetKey = metric + 'Target';
      const withTargets = data.filter(d => d[targetKey]);
      if (withTargets.length > 0) {
        const avgActual = withTargets.reduce((sum, d) => sum + (d[metric] || 0), 0) / withTargets.length;
        const avgTarget = withTargets.reduce((sum, d) => sum + (d[targetKey] || 0), 0) / withTargets.length;
        const compliance = Math.round((avgActual / avgTarget) * 100);
        const compColor = compliance >= 90 && compliance <= 110 ? '#00ff88' : compliance >= 80 ? '#ffaa00' : '#ff6b6b';
        
        html += `<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:11px;">
          <span>${metricConfig[metric].label}</span>
          <span><span style="color:#888;">${Math.round(avgActual)} / ${Math.round(avgTarget)}</span> <span style="color:${compColor};margin-left:8px;">${compliance}%</span></span>
        </div>`;
      }
    });
    html += '</div>';
  }
  
  document.getElementById('raw-data-summary').innerHTML = html;
}

function renderCorrelationInsights(data) {
  if (data.length < 14) {
    document.getElementById('correlation-insights').innerHTML = '<p style="font-size:11px;color:#555;text-align:center;">Need at least 2 weeks of data for insights</p>';
    return;
  }
  
  const insights = [];
  
  // Split data into periods to detect changes
  const midpoint = Math.floor(data.length / 2);
  const firstHalf = data.slice(0, midpoint);
  const secondHalf = data.slice(midpoint);
  
  // Helper to calculate average
  const avg = (arr, key) => arr.reduce((sum, d) => sum + (parseFloat(d[key]) || 0), 0) / arr.length;
  
  // Analyze calorie/carb changes vs outcomes
  const calFirst = avg(firstHalf, 'calories');
  const calSecond = avg(secondHalf, 'calories');
  const calChange = ((calSecond - calFirst) / calFirst * 100).toFixed(0);
  
  const carbFirst = avg(firstHalf, 'carbs');
  const carbSecond = avg(secondHalf, 'carbs');
  const carbChange = ((carbSecond - carbFirst) / carbFirst * 100).toFixed(0);
  
  const sleepFirst = avg(firstHalf, 'sleep');
  const sleepSecond = avg(secondHalf, 'sleep');
  const sleepChange = (sleepSecond - sleepFirst).toFixed(1);
  
  const recoveryFirst = avg(firstHalf, 'recovery');
  const recoverySecond = avg(secondHalf, 'recovery');
  const recoveryChange = (recoverySecond - recoveryFirst).toFixed(0);
  
  const bfFirst = avg(firstHalf, 'bodyFat');
  const bfSecond = avg(secondHalf, 'bodyFat');
  const bfChange = (bfSecond - bfFirst).toFixed(1);
  
  // Get PR changes
  const squatFirst = firstHalf[firstHalf.length - 1]?.squatPR || 0;
  const squatSecond = secondHalf[secondHalf.length - 1]?.squatPR || 0;
  const deadliftFirst = firstHalf[firstHalf.length - 1]?.deadliftPR || 0;
  const deadliftSecond = secondHalf[secondHalf.length - 1]?.deadliftPR || 0;
  
  // Generate insights based on correlations
  if (Math.abs(calChange) > 5) {
    const calDir = calChange > 0 ? 'increased' : 'decreased';
    const calIcon = calChange > 0 ? '↑' : '↓';
    
    // Calories vs Sleep
    if (calChange > 5 && sleepChange > 0.2) {
      insights.push({ icon: '😴', color: '#00ff88', text: `When calories ${calDir} ${Math.abs(calChange)}%, sleep improved by ${sleepChange}hrs` });
    } else if (calChange < -5 && sleepChange < -0.2) {
      insights.push({ icon: '⚠️', color: '#ffaa00', text: `Calorie deficit may be affecting sleep (-${Math.abs(sleepChange)}hrs avg)` });
    }
    
    // Calories vs Body Fat
    if (calChange > 5 && bfChange < -0.3) {
      insights.push({ icon: '🔥', color: '#00ff88', text: `Higher calories (${calIcon}${Math.abs(calChange)}%) + training = body fat ↓${Math.abs(bfChange)}%` });
    } else if (calChange < -5 && bfChange < -0.5) {
      insights.push({ icon: '📉', color: '#4169E1', text: `Calorie deficit working: body fat down ${Math.abs(bfChange)}%` });
    }
    
    // Calories vs PRs
    if (calChange > 5 && (squatSecond > squatFirst || deadliftSecond > deadliftFirst)) {
      const prGains = [];
      if (squatSecond > squatFirst) prGains.push(`Squat +${squatSecond - squatFirst}lbs`);
      if (deadliftSecond > deadliftFirst) prGains.push(`Deadlift +${deadliftSecond - deadliftFirst}lbs`);
      insights.push({ icon: '💪', color: '#00ff88', text: `Higher fuel = PR gains: ${prGains.join(', ')}` });
    }
  }
  
  // Carbs vs Recovery
  if (Math.abs(carbChange) > 8) {
    if (carbChange > 8 && recoveryChange > 3) {
      insights.push({ icon: '⚡', color: '#00ff88', text: `Carb increase (${carbChange}%) correlates with +${recoveryChange}% recovery` });
    } else if (carbChange < -8 && recoveryChange < -3) {
      insights.push({ icon: '🔋', color: '#ffaa00', text: `Lower carbs may be impacting recovery (${recoveryChange}%)` });
    }
  }
  
  // Sleep vs Recovery correlation
  if (sleepChange > 0.3 && recoveryChange > 5) {
    insights.push({ icon: '✨', color: '#00ff88', text: `Better sleep (+${sleepChange}hrs) driving recovery improvements` });
  }
  
  // Compliance insight
  const calCompliance = data.filter(d => d.caloriesTarget).map(d => d.calories / d.caloriesTarget);
  const avgCompliance = calCompliance.reduce((a,b) => a+b, 0) / calCompliance.length;
  if (avgCompliance >= 0.9 && avgCompliance <= 1.1) {
    insights.push({ icon: '🎯', color: '#00ff88', text: `Strong nutrition compliance (${Math.round(avgCompliance * 100)}%) - keep it up!` });
  } else if (avgCompliance < 0.85) {
    insights.push({ icon: '📊', color: '#ffaa00', text: `Calorie intake averaging ${Math.round(avgCompliance * 100)}% of target - room to improve` });
  }
  
  // Default insight if none generated
  if (insights.length === 0) {
    insights.push({ icon: '📈', color: '#4169E1', text: 'Tracking data - correlations will appear as patterns emerge' });
  }
  
  let html = '';
  insights.forEach(insight => {
    html += `<div style="display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid #1a1a1a;">
      <span style="font-size:18px;">${insight.icon}</span>
      <span style="font-size:12px;color:${insight.color};line-height:1.4;">${insight.text}</span>
    </div>`;
  });
  
  document.getElementById('correlation-insights').innerHTML = html;
}

function toggleSource(source) {
  sources[source] = !sources[source];
  localStorage.setItem('fitsync_sources', JSON.stringify(sources));
  updateUI();
  if (sources[source]) alert(source.charAt(0).toUpperCase() + source.slice(1) + ' connected!');
}

function clearData() { if (confirm('Clear all data?')) { localStorage.clear(); location.reload(); } }

// Bulk Upload Template (All Clients)
function downloadBulkTemplate() {
  const template = `Client Email,Date,Workout Name,Exercise,Sets,Weight,Reps,Notes,Protein Target,Carbs Target,Fats Target,Calories Target
ari@fitsync.app,2024-12-18,Push Day A,Bench Press,3,135,10,Focus on form,150,200,60,2200
ari@fitsync.app,2024-12-18,Push Day A,Shoulder Press,3,65,10,,,,
ari@fitsync.app,2024-12-20,Pull Day A,Deadlift,4,185,8,Keep back straight,150,200,60,2200
john@email.com,2024-12-18,Upper Body,Bench Press,4,185,6,,180,250,70,2600
john@email.com,2024-12-20,Lower Body,Squat,4,225,6,,180,250,70,2600
sarah@email.com,2024-12-18,Full Body,Squat,3,95,10,,140,180,50,1900`;
  
  const blob = new Blob([template], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'FitSync_All_Clients_Program.csv';
  a.click();
  URL.revokeObjectURL(url);
}

// Bulk Upload Handler (All Clients)
function handleBulkExcelUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const text = e.target.result;
    parseAndImportBulkProgram(text);
  };
  reader.readAsText(file);
  event.target.value = '';
}

function parseAndImportBulkProgram(csvText) {
  const lines = csvText.trim().split('\n');
  if (lines.length < 2) { alert('Empty or invalid file'); return; }
  
  const header = lines[0].split(',').map(h => h.trim().toLowerCase());
  const emailIdx = header.findIndex(h => h.includes('email'));
  const dateIdx = header.findIndex(h => h.includes('date'));
  const workoutIdx = header.findIndex(h => h.includes('workout'));
  const exerciseIdx = header.findIndex(h => h.includes('exercise'));
  const setsIdx = header.findIndex(h => h.includes('sets'));
  const weightIdx = header.findIndex(h => h.includes('weight'));
  const repsIdx = header.findIndex(h => h.includes('reps'));
  const notesIdx = header.findIndex(h => h.includes('notes'));
  const proteinIdx = header.findIndex(h => h.includes('protein'));
  const carbsIdx = header.findIndex(h => h.includes('carbs'));
  const fatsIdx = header.findIndex(h => h.includes('fats'));
  const caloriesIdx = header.findIndex(h => h.includes('calories'));
  
  if (emailIdx < 0 || dateIdx < 0 || workoutIdx < 0) {
    alert('Missing required columns: Client Email, Date, Workout Name');
    return;
  }
  
  const workoutMap = {};
  const nutritionMap = {};
  const clientsAdded = new Set();
  
  for (let i = 1; i < lines.length; i++) {
    const cols = lines[i].split(',').map(c => c.trim());
    if (cols.length < 3) continue;
    
    const email = cols[emailIdx];
    const date = cols[dateIdx];
    const workoutName = cols[workoutIdx];
    const exercise = exerciseIdx >= 0 ? cols[exerciseIdx] : '';
    const numSets = parseInt(cols[setsIdx]) || 3;
    const weight = weightIdx >= 0 ? cols[weightIdx] : '0';
    const reps = parseInt(cols[repsIdx]) || 10;
    const notes = notesIdx >= 0 ? cols[notesIdx] : '';
    
    if (!email || !date || !workoutName) continue;
    
    // Find or create client
    let client = clients.find(c => c.email.toLowerCase() === email.toLowerCase());
    if (!client) {
      const name = email.split('@')[0].replace(/[^a-zA-Z]/g, ' ').trim();
      client = { id: 'client_' + Date.now() + '_' + i, name: name.charAt(0).toUpperCase() + name.slice(1), email };
      clients.push(client);
    }
    clientsAdded.add(client.name);
    
    const key = `${client.id}_${date}_${workoutName}`;
    if (!workoutMap[key]) {
      workoutMap[key] = {
        id: 'sched_bulk_' + Date.now() + '_' + i,
        clientId: client.id,
        date,
        name: workoutName,
        notes,
        exercises: []
      };
    }
    
    if (exercise) {
      const sets = [];
      const w = weight === 'BW' ? 0 : parseInt(weight) || 0;
      for (let s = 0; s < numSets; s++) {
        sets.push({ w, r: reps });
      }
      workoutMap[key].exercises.push({ name: exercise, sets });
    }
    
    // Nutrition targets per client
    if (proteinIdx >= 0 && cols[proteinIdx]) {
      nutritionMap[client.id] = {
        protein: parseInt(cols[proteinIdx]) || 150,
        carbs: parseInt(cols[carbsIdx]) || 200,
        fats: parseInt(cols[fatsIdx]) || 60,
        calories: parseInt(cols[caloriesIdx]) || 2200
      };
    }
  }
  
  // Import workouts
  let importedCount = 0;
  Object.values(workoutMap).forEach(w => {
    scheduledWorkouts = scheduledWorkouts.filter(sw => 
      !(sw.clientId === w.clientId && sw.date === w.date && sw.name === w.name)
    );
    scheduledWorkouts.push(w);
    importedCount++;
  });
  
  localStorage.setItem('fitsync_scheduled', JSON.stringify(scheduledWorkouts));
  
  // Update nutrition for demo client if present
  if (nutritionMap['demo']) {
    nutritionTargets = nutritionMap['demo'];
    localStorage.setItem('fitsync_nutrition', JSON.stringify(nutritionTargets));
  }
  
  alert(`Imported ${importedCount} workouts for ${clientsAdded.size} clients:\n${[...clientsAdded].join(', ')}`);
  renderClients();
  updateUI();
}

// Per-Client Excel Template Download
function downloadClientTemplate() {
  const client = clients.find(c => c.id === selectedClient) || { name: 'Client', email: 'client@email.com' };
  const template = `Date,Workout Name,Exercise,Sets,Weight,Reps,Notes,Protein Target,Carbs Target,Fats Target,Calories Target
2024-12-18,Push Day A,Bench Press,3,135,10,Focus on form,150,200,60,2200
2024-12-18,Push Day A,Shoulder Press,3,65,10,,,,
2024-12-18,Push Day A,Tricep Dips,3,BW,12,,,,
2024-12-20,Pull Day A,Deadlift,4,185,8,Keep back straight,150,200,60,2200
2024-12-20,Pull Day A,Barbell Row,3,95,10,,,,
2024-12-22,Leg Day,Squat,4,155,8,Full depth,160,220,55,2300
2024-12-22,Leg Day,Leg Press,3,270,12,,,,`;
  
  const blob = new Blob([template], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `FitSync_${client.name.replace(/\s+/g, '_')}_Program.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// Per-Client Excel/CSV Upload Handler
function handleClientExcelUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const text = e.target.result;
    parseAndImportClientProgram(text, selectedClient);
  };
  reader.readAsText(file);
  event.target.value = '';
}

function parseAndImportClientProgram(csvText, clientId) {
  const lines = csvText.trim().split('\n');
  if (lines.length < 2) { alert('Empty or invalid file'); return; }
  
  const header = lines[0].split(',').map(h => h.trim().toLowerCase());
  const dateIdx = header.findIndex(h => h.includes('date'));
  const workoutIdx = header.findIndex(h => h.includes('workout'));
  const exerciseIdx = header.findIndex(h => h.includes('exercise'));
  const setsIdx = header.findIndex(h => h.includes('sets'));
  const weightIdx = header.findIndex(h => h.includes('weight'));
  const repsIdx = header.findIndex(h => h.includes('reps'));
  const notesIdx = header.findIndex(h => h.includes('notes'));
  const proteinIdx = header.findIndex(h => h.includes('protein'));
  const carbsIdx = header.findIndex(h => h.includes('carbs'));
  const fatsIdx = header.findIndex(h => h.includes('fats'));
  const caloriesIdx = header.findIndex(h => h.includes('calories'));
  
  if (dateIdx < 0 || workoutIdx < 0) {
    alert('Missing required columns: Date, Workout Name');
    return;
  }
  
  const workoutMap = {};
  let latestNutrition = null;
  
  for (let i = 1; i < lines.length; i++) {
    const cols = lines[i].split(',').map(c => c.trim());
    if (cols.length < 2) continue;
    
    const date = cols[dateIdx];
    const workoutName = cols[workoutIdx];
    const exercise = exerciseIdx >= 0 ? cols[exerciseIdx] : '';
    const numSets = parseInt(cols[setsIdx]) || 3;
    const weight = weightIdx >= 0 ? cols[weightIdx] : '0';
    const reps = parseInt(cols[repsIdx]) || 10;
    const notes = notesIdx >= 0 ? cols[notesIdx] : '';
    
    if (!date || !workoutName) continue;
    
    const key = `${date}_${workoutName}`;
    if (!workoutMap[key]) {
      workoutMap[key] = {
        id: 'sched_import_' + Date.now() + '_' + i,
        clientId,
        date,
        name: workoutName,
        notes,
        exercises: []
      };
    }
    
    if (exercise) {
      const sets = [];
      const w = weight === 'BW' ? 0 : parseInt(weight) || 0;
      for (let s = 0; s < numSets; s++) {
        sets.push({ w, r: reps });
      }
      workoutMap[key].exercises.push({ name: exercise, sets });
    }
    
    // Capture nutrition targets
    if (proteinIdx >= 0 && cols[proteinIdx]) {
      latestNutrition = {
        protein: parseInt(cols[proteinIdx]) || 150,
        carbs: parseInt(cols[carbsIdx]) || 200,
        fats: parseInt(cols[fatsIdx]) || 60,
        calories: parseInt(cols[caloriesIdx]) || 2200
      };
    }
  }
  
  // Import workouts for this client
  let importedCount = 0;
  Object.values(workoutMap).forEach(w => {
    scheduledWorkouts = scheduledWorkouts.filter(sw => 
      !(sw.clientId === clientId && sw.date === w.date && sw.name === w.name)
    );
    scheduledWorkouts.push(w);
    importedCount++;
  });
  
  localStorage.setItem('fitsync_scheduled', JSON.stringify(scheduledWorkouts));
  
  // Update nutrition for this client if provided
  if (latestNutrition && clientId === 'demo') {
    nutritionTargets = latestNutrition;
    localStorage.setItem('fitsync_nutrition', JSON.stringify(nutritionTargets));
    document.getElementById('nut-protein').value = latestNutrition.protein;
    document.getElementById('nut-carbs').value = latestNutrition.carbs;
    document.getElementById('nut-fats').value = latestNutrition.fats;
    document.getElementById('nut-calories').value = latestNutrition.calories;
  }
  
  const client = clients.find(c => c.id === clientId);
  alert(`Imported ${importedCount} workouts for ${client?.name || 'client'}!`);
  renderBuilderCalendar();
  updateUI();
}

// Sessions Functions
function setCalendarView(view) {
  calendarView = view;
  calendarOffset = 0;
  document.querySelectorAll('#sessions .time-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  renderTrainerSessions();
}

function calendarPrev() { calendarOffset--; renderTrainerSessions(); }
function calendarNext() { calendarOffset++; renderTrainerSessions(); }

function renderTrainerSessions() {
  const todayStr = new Date().toISOString().split('T')[0];
  const now = new Date();
  const weekStart = new Date(now); weekStart.setDate(now.getDate() - now.getDay());
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  
  // Calculate revenue
  const todayRevenue = sessions.filter(s => s.date === todayStr).reduce((sum, s) => sum + s.rate, 0);
  const weekRevenue = sessions.filter(s => new Date(s.date) >= weekStart).reduce((sum, s) => sum + s.rate, 0);
  const monthRevenue = sessions.filter(s => new Date(s.date) >= monthStart).reduce((sum, s) => sum + s.rate, 0);
  
  // Render calendar
  renderSessionsCalendar();
  
  document.getElementById('revenue-today').textContent = '$' + todayRevenue;
  document.getElementById('revenue-week').textContent = '$' + weekRevenue;
  document.getElementById('revenue-month').textContent = '$' + monthRevenue;
  
  // Render upcoming sessions
  const upcoming = sessions.filter(s => s.date >= todayStr).sort((a, b) => {
    if (a.date !== b.date) return a.date.localeCompare(b.date);
    return a.time.localeCompare(b.time);
  });
  
  let html = '';
  let currentDate = '';
  
  upcoming.forEach(s => {
    if (s.date !== currentDate) {
      currentDate = s.date;
      const dateObj = new Date(s.date + 'T12:00:00');
      const isToday = s.date === todayStr;
      html += `<div style="font-size:11px;color:#666;margin:16px 0 8px;letter-spacing:1px;">${isToday ? 'TODAY' : dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' }).toUpperCase()}</div>`;
    }
    
    const isToday = s.date === todayStr;
    html += `
      <div class="session-card ${isToday ? 'today' : 'upcoming'}">
        <div class="session-time">${formatTime(s.time)}</div>
        <div class="session-client">${s.clientName}</div>
        <div class="session-details">
          <span class="session-trainer">${s.trainerName}</span>
          <span class="session-location">${s.location}</span>
          <span class="session-revenue">$${s.rate}</span>
        </div>
      </div>`;
  });
  
  document.getElementById('trainer-sessions-list').innerHTML = html || '<div class="calendar-empty">No upcoming sessions</div>';
  
  // Update Calendly status
  const calendlyEl = document.getElementById('calendly-status');
  if (calendlyEl) {
    calendlyEl.textContent = sources.calendly ? 'Connected' : 'Connect';
    calendlyEl.classList.toggle('connected', sources.calendly);
  }
}

function renderClientSessions() {
  const todayStr = new Date().toISOString().split('T')[0];
  const mySessions = sessions.filter(s => s.clientId === 'demo' && s.date >= todayStr).sort((a, b) => {
    if (a.date !== b.date) return a.date.localeCompare(b.date);
    return a.time.localeCompare(b.time);
  });
  
  let html = '';
  
  // Show reminder for next session
  if (mySessions.length > 0) {
    const next = mySessions[0];
    const nextDate = new Date(next.date + 'T' + next.time);
    const hoursUntil = Math.round((nextDate - new Date()) / (1000 * 60 * 60));
    
    if (hoursUntil <= 24 && hoursUntil > 0) {
      html += `<div class="session-reminder">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg>
        Next session in ${hoursUntil} hour${hoursUntil !== 1 ? 's' : ''} with ${next.trainerName}
      </div>`;
    }
  }
  
  mySessions.forEach(s => {
    const dateObj = new Date(s.date + 'T12:00:00');
    const isToday = s.date === todayStr;
    
    html += `
      <div class="session-card ${isToday ? 'today' : 'upcoming'}">
        <div class="session-time">${isToday ? 'Today' : dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })} • ${formatTime(s.time)}</div>
        <div class="session-client">${s.trainerName}</div>
        <div class="session-details">
          <span class="session-location">${s.location}</span>
        </div>
      </div>`;
  });
  
  document.getElementById('client-sessions-list').innerHTML = html || '<div class="calendar-empty">No upcoming sessions</div>';
}

function formatTime(time) {
  const [h, m] = time.split(':');
  const hour = parseInt(h);
  const ampm = hour >= 12 ? 'PM' : 'AM';
  const hour12 = hour % 12 || 12;
  return `${hour12}:${m} ${ampm}`;
}

function renderSessionsCalendar() {
  const now = new Date();
  const todayStr = now.toISOString().split('T')[0];
  const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  
  let html = '<div class="cal-grid">';
  days.forEach(d => html += `<div class="cal-header">${d}</div>`);
  
  if (calendarView === 'week') {
    // Week view
    const weekStart = new Date(now);
    weekStart.setDate(now.getDate() - now.getDay() + (calendarOffset * 7));
    
    const label = calendarOffset === 0 ? 'This Week' : 
      weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' - ' + 
      new Date(weekStart.getTime() + 6*24*60*60*1000).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    document.getElementById('calendar-label').textContent = label;
    
    for (let i = 0; i < 7; i++) {
      const d = new Date(weekStart);
      d.setDate(weekStart.getDate() + i);
      const dateStr = d.toISOString().split('T')[0];
      const daySessions = sessions.filter(s => s.date === dateStr);
      const isToday = dateStr === todayStr;
      
      html += `<div class="cal-day ${isToday ? 'today' : ''}" onclick="showDaySessions('${dateStr}')">
        <div class="cal-day-num">${d.getDate()}</div>
        ${daySessions.length > 0 ? `<div class="cal-session-count">${daySessions.length} session${daySessions.length > 1 ? 's' : ''}</div>` : ''}
      </div>`;
    }
  } else {
    // Month view
    const monthDate = new Date(now.getFullYear(), now.getMonth() + calendarOffset, 1);
    const monthEnd = new Date(now.getFullYear(), now.getMonth() + calendarOffset + 1, 0);
    const startDay = monthDate.getDay();
    
    document.getElementById('calendar-label').textContent = monthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    
    // Previous month days
    for (let i = 0; i < startDay; i++) {
      const d = new Date(monthDate);
      d.setDate(d.getDate() - (startDay - i));
      html += `<div class="cal-day other-month"><div class="cal-day-num">${d.getDate()}</div></div>`;
    }
    
    // Current month days
    for (let i = 1; i <= monthEnd.getDate(); i++) {
      const d = new Date(now.getFullYear(), now.getMonth() + calendarOffset, i);
      const dateStr = d.toISOString().split('T')[0];
      const daySessions = sessions.filter(s => s.date === dateStr);
      const isToday = dateStr === todayStr;
      
      html += `<div class="cal-day ${isToday ? 'today' : ''}" onclick="showDaySessions('${dateStr}')">
        <div class="cal-day-num">${i}</div>
        ${daySessions.length > 0 ? daySessions.slice(0, 3).map(() => '<span class="cal-session-dot"></span>').join('') : ''}
      </div>`;
    }
  }
  
  html += '</div>';
  document.getElementById('sessions-calendar').innerHTML = html;
}

function showDaySessions(dateStr) {
  const daySessions = sessions.filter(s => s.date === dateStr).sort((a, b) => a.time.localeCompare(b.time));
  if (daySessions.length === 0) {
    alert('No sessions on this day');
    return;
  }
  
  const dateObj = new Date(dateStr + 'T12:00:00');
  let msg = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }) + '\\n\\n';
  daySessions.forEach(s => {
    msg += `${formatTime(s.time)} - ${s.clientName} (${s.trainerName}) $${s.rate}\\n`;
  });
  msg += `\\nTotal: $${daySessions.reduce((sum, s) => sum + s.rate, 0)}`;
  alert(msg);
}

// Client Sessions Calendar (for Program page) - Condensed week view
function renderClientSessionsCalendar() {
  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];
  
  // Get start of current week (Sunday)
  const weekStart = new Date(today);
  weekStart.setDate(today.getDate() - today.getDay());
  
  // Build week grid header
  const days = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
  let html = '<div class="client-week-grid">';
  
  for (let i = 0; i < 7; i++) {
    const d = new Date(weekStart);
    d.setDate(weekStart.getDate() + i);
    const dateStr = d.toISOString().split('T')[0];
    const isToday = dateStr === todayStr;
    const daySession = sessions.find(s => s.clientId === 'demo' && s.date === dateStr);
    
    html += `
      <div class="client-week-day ${isToday ? 'today' : ''} ${daySession ? 'has-session' : ''}" ${daySession ? `onclick="openSessionDetail('${daySession.id}')"` : ''}>
        <div class="client-week-day-name">${days[i]}</div>
        <div class="client-week-day-num">${d.getDate()}</div>
        ${daySession ? '<div class="client-week-dot"></div>' : ''}
      </div>`;
  }
  html += '</div>';
  
  // Show next 2 upcoming sessions below
  const mySessions = sessions.filter(s => s.clientId === 'demo' && s.date >= todayStr).sort((a, b) => {
    if (a.date !== b.date) return a.date.localeCompare(b.date);
    return a.time.localeCompare(b.time);
  }).slice(0, 2);
  
  if (mySessions.length > 0) {
    html += '<div style="margin-top:12px;">';
    mySessions.forEach(s => {
      const dateObj = new Date(s.date + 'T12:00:00');
      const isToday = s.date === todayStr;
      const isPending = s.changeRequest;
      
      html += `
        <div class="client-session-mini ${isPending ? 'pending' : ''}" onclick="openSessionDetail('${s.id}')">
          <div class="client-session-mini-date">${isToday ? 'Today' : dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</div>
          <div class="client-session-mini-time">${formatTime(s.time)}</div>
          <div class="client-session-mini-trainer">${s.trainerName}</div>
          ${isPending ? '<span class="client-session-mini-badge">PENDING</span>' : ''}
        </div>`;
    });
    html += '</div>';
  }
  
  const container = document.getElementById('client-sessions-calendar');
  if (container) container.innerHTML = html;
}

function openSessionDetail(sessionId) {
  const s = sessions.find(x => x.id === sessionId);
  if (!s) return;
  
  const dateObj = new Date(s.date + 'T12:00:00');
  document.getElementById('session-content').innerHTML = `
    <div style="text-align:center;padding:20px 0;">
      <div style="font-size:13px;color:#4169E1;">${dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</div>
      <div style="font-size:32px;font-weight:700;margin:8px 0;">${formatTime(s.time)}</div>
      <div style="font-size:18px;color:#888;">${s.trainerName}</div>
      <div style="font-size:14px;color:#666;margin-top:4px;">${s.location}</div>
    </div>
    ${s.changeRequest ? '<div class="session-reminder" style="background:#ffaa0020;border-color:#ffaa0040;color:#ffaa00;margin:20px 0;">Change request pending trainer approval</div>' : ''}
    <div class="session-actions" style="margin-top:30px;">
      <div class="session-action-btn change" onclick="requestSessionChange('${s.id}')">Request Change</div>
      <div class="session-action-btn cancel" onclick="requestSessionCancel('${s.id}')">Request Cancel</div>
    </div>
    <p style="font-size:11px;color:#555;text-align:center;margin-top:16px;">Changes require trainer approval</p>
  `;
  document.getElementById('session-modal').classList.add('active');
}

function closeSessionModal() { document.getElementById('session-modal').classList.remove('active'); }

function requestSessionChange(sessionId) {
  const s = sessions.find(x => x.id === sessionId);
  if (!s) return;
  if (confirm('Request to reschedule this session?')) {
    s.changeRequest = 'reschedule';
    localStorage.setItem('fitsync_sessions', JSON.stringify(sessions));
    alert('Request sent! Your trainer will review and approve the change.');
    closeSessionModal();
    renderClientSessionsCalendar();
  }
}

function requestSessionCancel(sessionId) {
  const s = sessions.find(x => x.id === sessionId);
  if (!s) return;
  if (confirm('Request to cancel this session?')) {
    s.changeRequest = 'cancel';
    localStorage.setItem('fitsync_sessions', JSON.stringify(sessions));
    alert('Cancellation request sent! Your trainer will review and confirm.');
    closeSessionModal();
    renderClientSessionsCalendar();
  }
}

// Labs / Blood Panels (Full Panel)
let labResults = JSON.parse(localStorage.getItem('fitsync_labs') || '[]');

function initLabs() {
  // Always ensure demo data exists for the demo client
  const hasDemoLabs = labResults.some(l => l.clientId === 'demo');
  if (!hasDemoLabs) {
    labResults = [
      // Q4 2025 - Most recent (showing improvement)
      { id: 1, clientId: 'demo', date: '2025-12-10', provider: 'Quest Diagnostics', 
        wbc: 6.0, rbc: 4.9, hemoglobin: 14.8, hematocrit: 44, platelets: 255,
        glucose: 88, a1c: 5.2, creatinine: 0.85, bun: 14, egfr: 98, sodium: 140, potassium: 4.1,
        cholesterol: 175, ldl: 95, hdl: 62, triglycerides: 85,
        alt: 20, ast: 22, tsh: 2.0, crp: 0.5 },
      // Q3 2025
      { id: 2, clientId: 'demo', date: '2025-09-15', provider: 'Quest Diagnostics',
        wbc: 6.2, rbc: 4.8, hemoglobin: 14.5, hematocrit: 43, platelets: 250,
        glucose: 92, a1c: 5.4, creatinine: 0.9, bun: 15, egfr: 95, sodium: 140, potassium: 4.2,
        cholesterol: 185, ldl: 110, hdl: 55, triglycerides: 100,
        alt: 22, ast: 25, tsh: 2.1, crp: 0.8 },
      // Q2 2025
      { id: 3, clientId: 'demo', date: '2025-06-12', provider: 'LabCorp',
        wbc: 5.8, rbc: 4.6, hemoglobin: 14.2, hematocrit: 42, platelets: 245,
        glucose: 98, a1c: 5.6, creatinine: 1.0, bun: 16, egfr: 90, sodium: 141, potassium: 4.0,
        cholesterol: 195, ldl: 125, hdl: 50, triglycerides: 120,
        alt: 28, ast: 30, tsh: 2.5, crp: 1.2 },
      // Q1 2025 - Baseline (starting point)
      { id: 4, clientId: 'demo', date: '2025-03-08', provider: 'Quest Diagnostics',
        wbc: 5.5, rbc: 4.4, hemoglobin: 13.8, hematocrit: 41, platelets: 240,
        glucose: 105, a1c: 5.9, creatinine: 1.1, bun: 18, egfr: 85, sodium: 142, potassium: 3.9,
        cholesterol: 215, ldl: 145, hdl: 42, triglycerides: 155,
        alt: 35, ast: 38, tsh: 3.2, crp: 2.1 }
    ];
    localStorage.setItem('fitsync_labs', JSON.stringify(labResults));
  }
}

function renderLabs() {
  initLabs();
  const container = document.getElementById('labs-list');
  const trendsContainer = document.getElementById('labs-trends');
  if (!container) return;
  
  const clientLabs = labResults.filter(l => l.clientId === 'demo').sort((a,b) => b.date.localeCompare(a.date));
  if (clientLabs.length === 0) {
    container.innerHTML = '<div class="calendar-empty">No lab results yet</div>';
    if (trendsContainer) trendsContainer.style.display = 'none';
    return;
  }
  
  // Calculate trends (compare most recent to oldest)
  if (trendsContainer && clientLabs.length >= 2) {
    const latest = clientLabs[0];
    const oldest = clientLabs[clientLabs.length - 1];
    
    const getTrend = (curr, prev, lowerBetter) => {
      if (!curr || !prev) return { arrow: '', color: '#666', change: '--' };
      const diff = curr - prev;
      const pct = ((diff / prev) * 100).toFixed(0);
      const improved = lowerBetter ? diff < 0 : diff > 0;
      return {
        arrow: diff > 0 ? '↑' : diff < 0 ? '↓' : '→',
        color: improved ? '#00ff88' : diff === 0 ? '#666' : '#ff6b6b',
        change: (diff > 0 ? '+' : '') + pct + '%'
      };
    };
    
    const cholTrend = getTrend(latest.cholesterol, oldest.cholesterol, true);
    const ldlTrend = getTrend(latest.ldl, oldest.ldl, true);
    const hdlTrend = getTrend(latest.hdl, oldest.hdl, false);
    const a1cTrend = getTrend(latest.a1c, oldest.a1c, true);
    const crpTrend = getTrend(latest.crp, oldest.crp, true);
    const glucoseTrend = getTrend(latest.glucose, oldest.glucose, true);
    
    trendsContainer.innerHTML = `
      <div style="font-size:10px;color:#666;margin-bottom:12px;">SINCE ${new Date(oldest.date + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', year: 'numeric' }).toUpperCase()}</div>
      <div class="lab-trends-grid">
        <div class="lab-trend-item"><span class="lab-trend-label">Cholesterol</span><span class="lab-trend-value" style="color:${cholTrend.color}">${cholTrend.arrow} ${cholTrend.change}</span></div>
        <div class="lab-trend-item"><span class="lab-trend-label">LDL</span><span class="lab-trend-value" style="color:${ldlTrend.color}">${ldlTrend.arrow} ${ldlTrend.change}</span></div>
        <div class="lab-trend-item"><span class="lab-trend-label">HDL</span><span class="lab-trend-value" style="color:${hdlTrend.color}">${hdlTrend.arrow} ${hdlTrend.change}</span></div>
        <div class="lab-trend-item"><span class="lab-trend-label">A1C</span><span class="lab-trend-value" style="color:${a1cTrend.color}">${a1cTrend.arrow} ${a1cTrend.change}</span></div>
        <div class="lab-trend-item"><span class="lab-trend-label">hs-CRP</span><span class="lab-trend-value" style="color:${crpTrend.color}">${crpTrend.arrow} ${crpTrend.change}</span></div>
        <div class="lab-trend-item"><span class="lab-trend-label">Glucose</span><span class="lab-trend-value" style="color:${glucoseTrend.color}">${glucoseTrend.arrow} ${glucoseTrend.change}</span></div>
      </div>`;
  }
  
  // Color coding based on typical ranges
  const getClass = (val, low, high) => !val ? '' : val < low || val > high ? 'warning' : 'normal';
  
  container.innerHTML = clientLabs.map((lab, idx) => {
    const dateObj = new Date(lab.date + 'T12:00:00');
    const dateStr = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    const quarter = 'Q' + (Math.floor(dateObj.getMonth() / 3) + 1) + ' ' + dateObj.getFullYear();
    
    return `
      <div class="lab-card" onclick="viewLabDetail('${lab.id}')">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div class="lab-card-date">${dateStr}</div>
          <span style="font-size:10px;color:#4169E1;background:#4169E120;padding:3px 8px;border-radius:4px;">${quarter}</span>
        </div>
        <div class="lab-card-provider">${lab.provider}</div>
        <div class="lab-metrics">
          <div class="lab-metric"><div class="lab-metric-value ${getClass(lab.glucose, 70, 100)}">${lab.glucose || '--'}</div><div class="lab-metric-label">GLUCOSE</div></div>
          <div class="lab-metric"><div class="lab-metric-value ${getClass(lab.a1c, 0, 5.7)}">${lab.a1c || '--'}</div><div class="lab-metric-label">A1C</div></div>
          <div class="lab-metric"><div class="lab-metric-value ${getClass(lab.cholesterol, 0, 200)}">${lab.cholesterol || '--'}</div><div class="lab-metric-label">CHOL</div></div>
          <div class="lab-metric"><div class="lab-metric-value ${getClass(lab.ldl, 0, 100)}">${lab.ldl || '--'}</div><div class="lab-metric-label">LDL</div></div>
          <div class="lab-metric"><div class="lab-metric-value ${getClass(lab.wbc, 4.5, 11)}">${lab.wbc || '--'}</div><div class="lab-metric-label">WBC</div></div>
          <div class="lab-metric"><div class="lab-metric-value ${getClass(lab.crp, 0, 3)}">${lab.crp || '--'}</div><div class="lab-metric-label">hs-CRP</div></div>
        </div>
      </div>`;
  }).join('');
}

function openLabsModal() {
  document.getElementById('lab-date').value = new Date().toISOString().split('T')[0];
  ['provider','wbc','rbc','hemoglobin','hematocrit','platelets','glucose','a1c','creatinine','bun','egfr','sodium','potassium','cholesterol','ldl','hdl','triglycerides','alt','ast','tsh','crp'].forEach(f => {
    const el = document.getElementById('lab-' + f);
    if (el) el.value = '';
  });
  document.getElementById('labs-modal').classList.add('active');
}

function closeLabsModal() { document.getElementById('labs-modal').classList.remove('active'); }

function saveLabResults() {
  const lab = {
    id: Date.now(),
    clientId: document.getElementById('lab-client').value,
    date: document.getElementById('lab-date').value,
    provider: document.getElementById('lab-provider').value || 'Unknown',
    wbc: parseFloat(document.getElementById('lab-wbc').value) || null,
    rbc: parseFloat(document.getElementById('lab-rbc').value) || null,
    hemoglobin: parseFloat(document.getElementById('lab-hemoglobin').value) || null,
    hematocrit: parseFloat(document.getElementById('lab-hematocrit').value) || null,
    platelets: parseFloat(document.getElementById('lab-platelets').value) || null,
    glucose: parseFloat(document.getElementById('lab-glucose').value) || null,
    a1c: parseFloat(document.getElementById('lab-a1c').value) || null,
    creatinine: parseFloat(document.getElementById('lab-creatinine').value) || null,
    bun: parseFloat(document.getElementById('lab-bun').value) || null,
    egfr: parseFloat(document.getElementById('lab-egfr').value) || null,
    sodium: parseFloat(document.getElementById('lab-sodium').value) || null,
    potassium: parseFloat(document.getElementById('lab-potassium').value) || null,
    cholesterol: parseFloat(document.getElementById('lab-cholesterol').value) || null,
    ldl: parseFloat(document.getElementById('lab-ldl').value) || null,
    hdl: parseFloat(document.getElementById('lab-hdl').value) || null,
    triglycerides: parseFloat(document.getElementById('lab-triglycerides').value) || null,
    alt: parseFloat(document.getElementById('lab-alt').value) || null,
    ast: parseFloat(document.getElementById('lab-ast').value) || null,
    tsh: parseFloat(document.getElementById('lab-tsh').value) || null,
    crp: parseFloat(document.getElementById('lab-crp').value) || null
  };
  
  labResults.push(lab);
  localStorage.setItem('fitsync_labs', JSON.stringify(labResults));
  closeLabsModal();
  alert('Lab results uploaded for client!');
}

function viewLabDetail(labId) {
  const lab = labResults.find(l => l.id == labId);
  if (!lab) return;
  
  const dateObj = new Date(lab.date + 'T12:00:00');
  const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
  
  alert(`Lab Results - ${dateStr}\n${lab.provider}\n\n` +
    `CBC\nWBC: ${lab.wbc || '--'} K/uL | RBC: ${lab.rbc || '--'} M/uL\nHemoglobin: ${lab.hemoglobin || '--'} g/dL | Hematocrit: ${lab.hematocrit || '--'}%\nPlatelets: ${lab.platelets || '--'} K/uL\n\n` +
    `METABOLIC\nGlucose: ${lab.glucose || '--'} mg/dL | HbA1c: ${lab.a1c || '--'}%\nCreatinine: ${lab.creatinine || '--'} | BUN: ${lab.bun || '--'} | eGFR: ${lab.egfr || '--'}\nSodium: ${lab.sodium || '--'} | Potassium: ${lab.potassium || '--'}\n\n` +
    `LIPID PANEL\nTotal: ${lab.cholesterol || '--'} | LDL: ${lab.ldl || '--'} | HDL: ${lab.hdl || '--'}\nTriglycerides: ${lab.triglycerides || '--'}\n\n` +
    `LIVER & OTHER\nALT: ${lab.alt || '--'} | AST: ${lab.ast || '--'}\nTSH: ${lab.tsh || '--'} | hs-CRP: ${lab.crp || '--'}`);
}

// Billing
let billingData = JSON.parse(localStorage.getItem('fitsync_billing') || '[]');

function initBilling() {
  if (billingData.length === 0) {
    billingData = [
      { id: 1, clientId: 'demo', clientName: 'Sarah Johnson', amount: 200, status: 'paid', date: '2025-12-01', method: 'Stripe' },
      { id: 2, clientId: 'c2', clientName: 'Mike Chen', amount: 200, status: 'paid', date: '2025-12-01', method: 'Paddle' },
      { id: 3, clientId: 'c3', clientName: 'Emma Davis', amount: 200, status: 'pending', date: '2025-12-01', method: 'Stripe' },
      { id: 4, clientId: 'demo', clientName: 'Sarah Johnson', amount: 200, status: 'paid', date: '2025-11-01', method: 'Stripe' },
      { id: 5, clientId: 'c2', clientName: 'Mike Chen', amount: 200, status: 'paid', date: '2025-11-01', method: 'Paddle' },
      { id: 6, clientId: 'c4', clientName: 'James Wilson', amount: 150, status: 'overdue', date: '2025-11-15', method: 'Square' }
    ];
    localStorage.setItem('fitsync_billing', JSON.stringify(billingData));
  }
}

function renderBilling() {
  initBilling();
  
  const collected = billingData.filter(b => b.status === 'paid').reduce((sum, b) => sum + b.amount, 0);
  const pending = billingData.filter(b => b.status === 'pending').reduce((sum, b) => sum + b.amount, 0);
  const overdue = billingData.filter(b => b.status === 'overdue').reduce((sum, b) => sum + b.amount, 0);
  
  document.getElementById('billing-collected').textContent = '$' + collected.toLocaleString();
  document.getElementById('billing-pending').textContent = '$' + pending.toLocaleString();
  document.getElementById('billing-overdue').textContent = '$' + overdue.toLocaleString();
  
  // Recent transactions
  const txContainer = document.getElementById('billing-transactions');
  const recent = billingData.sort((a,b) => b.date.localeCompare(a.date)).slice(0, 5);
  txContainer.innerHTML = recent.map(tx => {
    const statusColor = tx.status === 'paid' ? '#00ff88' : tx.status === 'pending' ? '#ffaa00' : '#ff6b6b';
    const dateStr = new Date(tx.date + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    return `
      <div class="billing-row">
        <div><div style="font-weight:600;">${tx.clientName}</div><div style="font-size:11px;color:#666;">${dateStr} • ${tx.method}</div></div>
        <div style="text-align:right;"><div style="font-weight:600;">$${tx.amount}</div><div style="font-size:10px;color:${statusColor};text-transform:uppercase;">${tx.status}</div></div>
      </div>`;
  }).join('');
  
  // Client billing status
  const clientContainer = document.getElementById('client-billing-list');
  const clientStatus = {};
  billingData.forEach(b => {
    if (!clientStatus[b.clientId] || b.date > clientStatus[b.clientId].date) {
      clientStatus[b.clientId] = b;
    }
  });
  clientContainer.innerHTML = Object.values(clientStatus).map(c => {
    const statusColor = c.status === 'paid' ? '#00ff88' : c.status === 'pending' ? '#ffaa00' : '#ff6b6b';
    return `
      <div class="billing-row">
        <span>${c.clientName}</span>
        <span style="color:${statusColor};font-weight:600;text-transform:uppercase;">${c.status}</span>
      </div>`;
  }).join('');
}

function connectPaddle() {
  sources.paddle = !sources.paddle;
  localStorage.setItem('fitsync_sources', JSON.stringify(sources));
  const el = document.getElementById('paddle-status');
  if (sources.paddle) {
    el.textContent = 'Connected'; el.classList.add('connected');
    alert('Paddle connected! Subscription payments will sync automatically.');
  } else {
    el.textContent = 'Connect'; el.classList.remove('connected');
  }
}

function connectStripe() {
  sources.stripe = !sources.stripe;
  localStorage.setItem('fitsync_sources', JSON.stringify(sources));
  const el = document.getElementById('stripe-status');
  if (sources.stripe) {
    el.textContent = 'Connected'; el.classList.add('connected');
    alert('Stripe connected! Payment data will sync automatically.');
  } else {
    el.textContent = 'Connect'; el.classList.remove('connected');
  }
}

function connectSquare() {
  sources.square = !sources.square;
  localStorage.setItem('fitsync_sources', JSON.stringify(sources));
  const el = document.getElementById('square-status');
  if (sources.square) {
    el.textContent = 'Connected'; el.classList.add('connected');
    alert('Square connected! In-person payments will sync.');
  } else {
    el.textContent = 'Connect'; el.classList.remove('connected');
  }
}

function connectQuickbooks() {
  sources.quickbooks = !sources.quickbooks;
  localStorage.setItem('fitsync_sources', JSON.stringify(sources));
  const el = document.getElementById('quickbooks-status');
  if (sources.quickbooks) {
    el.textContent = 'Connected'; el.classList.add('connected');
    alert('QuickBooks connected! Invoices and payments will sync.');
  } else {
    el.textContent = 'Connect'; el.classList.remove('connected');
  }
}

// Messages
let messages = JSON.parse(localStorage.getItem('fitsync_messages') || '[]');

function initMessages() {
  if (messages.length === 0) {
    messages = [
      { id: 1, from: 'trainer', text: 'Hey! Great session today. Remember to focus on your form during squats.', time: '2:30 PM' },
      { id: 2, from: 'client', text: 'Thanks coach! I felt really good about the deadlifts.', time: '2:45 PM' },
      { id: 3, from: 'trainer', text: 'Perfect! Lets increase the weight next week. Also, dont forget to log your meals!', time: '3:00 PM' }
    ];
    localStorage.setItem('fitsync_messages', JSON.stringify(messages));
  }
}

function openMessages() {
  initMessages();
  renderMessages();
  document.getElementById('messages-modal').classList.add('active');
  document.getElementById('msg-badge').style.display = 'none';
}

function closeMessages() { document.getElementById('messages-modal').classList.remove('active'); }

function renderMessages() {
  const container = document.getElementById('chat-messages');
  container.innerHTML = messages.map(m => `
    <div class="chat-msg ${m.from === 'client' ? 'sent' : 'received'}">
      ${m.text}
      <div class="chat-msg-time">${m.time}</div>
    </div>
  `).join('');
  container.scrollTop = container.scrollHeight;
}

function sendMessage() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text) return;
  
  const now = new Date();
  const time = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
  messages.push({ id: Date.now(), from: 'client', text, time });
  localStorage.setItem('fitsync_messages', JSON.stringify(messages));
  input.value = '';
  renderMessages();
  
  // Simulate trainer response
  setTimeout(() => {
    messages.push({ id: Date.now(), from: 'trainer', text: 'Got it! Ill get back to you shortly.', time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) });
    localStorage.setItem('fitsync_messages', JSON.stringify(messages));
    renderMessages();
  }, 1500);
}

function connectCalendly() {
  sources.calendly = !sources.calendly;
  localStorage.setItem('fitsync_sources', JSON.stringify(sources));
  
  if (sources.calendly) {
    alert('Calendly connected! Sessions will sync automatically.');
  } else {
    alert('Calendly disconnected');
  }
  renderTrainerSessions();
}

// Business Dashboard
let revenueChart = null;

function renderBusinessDashboard() {
  const now = new Date();
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  
  // Calculate metrics
  const monthSessions = sessions.filter(s => {
    const d = new Date(s.date);
    return d >= monthStart && d <= monthEnd;
  });
  
  const completedRevenue = monthSessions.filter(s => new Date(s.date) <= now).reduce((sum, s) => sum + s.rate, 0);
  const projectedRevenue = monthSessions.reduce((sum, s) => sum + s.rate, 0);
  const sessionCount = monthSessions.length;
  
  document.getElementById('biz-revenue-month').textContent = '$' + completedRevenue.toLocaleString();
  document.getElementById('biz-revenue-projected').textContent = '$' + projectedRevenue.toLocaleString();
  document.getElementById('biz-sessions-count').textContent = sessionCount;
  
  // Revenue by trainer
  const trainerRevenue = {};
  const trainerSessions = {};
  monthSessions.forEach(s => {
    trainerRevenue[s.trainerName] = (trainerRevenue[s.trainerName] || 0) + s.rate;
    trainerSessions[s.trainerName] = (trainerSessions[s.trainerName] || 0) + 1;
  });
  
  document.getElementById('trainer-revenue-list').innerHTML = Object.entries(trainerRevenue)
    .sort((a, b) => b[1] - a[1])
    .map(([name, revenue]) => `
      <div class="trainer-revenue-card">
        <div>
          <div class="trainer-revenue-name">${name}</div>
          <div class="trainer-revenue-sessions">${trainerSessions[name]} sessions</div>
        </div>
        <div class="trainer-revenue-amount">$${revenue.toLocaleString()}</div>
      </div>
    `).join('');
  
  // Client retention stats
  const uniqueClients = new Set(monthSessions.map(s => s.clientId)).size;
  const avgSessionsPerClient = uniqueClients > 0 ? (sessionCount / uniqueClients / 4).toFixed(1) : 0;
  const avgLTV = uniqueClients > 0 ? Math.round(projectedRevenue / uniqueClients * 12) : 0;
  
  document.getElementById('biz-active-clients').textContent = uniqueClients;
  document.getElementById('biz-avg-sessions').textContent = avgSessionsPerClient;
  document.getElementById('biz-ltv').textContent = '$' + avgLTV.toLocaleString();
  
  // Monthly revenue chart (last 6 months)
  const monthlyData = [];
  for (let i = 5; i >= 0; i--) {
    const m = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const mEnd = new Date(now.getFullYear(), now.getMonth() - i + 1, 0);
    const mLabel = m.toLocaleDateString('en-US', { month: 'short' });
    const mRevenue = sessions.filter(s => {
      const d = new Date(s.date);
      return d >= m && d <= mEnd;
    }).reduce((sum, s) => sum + s.rate, 0);
    monthlyData.push({ label: mLabel, value: mRevenue || Math.floor(2000 + Math.random() * 3000) });
  }
  
  const ctx = document.getElementById('revenueChart')?.getContext('2d');
  if (!ctx) return;
  if (revenueChart) revenueChart.destroy();
  
  revenueChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: monthlyData.map(d => d.label),
      datasets: [{
        data: monthlyData.map(d => d.value),
        backgroundColor: '#4169E1',
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { display: false }, ticks: { color: '#666' } },
        y: { grid: { color: '#222' }, ticks: { color: '#666', callback: v => '$' + v } }
      }
    }
  });
}

// TrueCoach Integration
function connectTrueCoach() {
  sources.truecoach = !sources.truecoach;
  localStorage.setItem('fitsync_sources', JSON.stringify(sources));
  const el = document.getElementById('truecoach-status');
  
  if (sources.truecoach) {
    el.textContent = 'Connected';
    el.classList.add('connected');
    alert('TrueCoach connected!\n\nIn production, this syncs your client programming automatically via TrueCoach API.\n\nWorkouts will appear in each client\'s program.');
  } else {
    el.textContent = 'Connect';
    el.classList.remove('connected');
    alert('TrueCoach disconnected');
  }
}

function importFromTrueCoach() {
  if (!sources.truecoach) {
    alert('Please connect TrueCoach first from the Clients page.');
    return;
  }
  alert('Importing workouts from TrueCoach...\n\nIn production, this pulls the client\'s assigned program from TrueCoach API.');
  // Simulate import
  setTimeout(() => {
    alert('✓ 12 workouts imported for this month!');
    renderBuilderCalendar();
  }, 1000);
}

// Trainerize Integration
function connectTrainerize() {
  sources.trainerize = !sources.trainerize;
  localStorage.setItem('fitsync_sources', JSON.stringify(sources));
  const el = document.getElementById('trainerize-status');
  
  if (sources.trainerize) {
    el.textContent = 'Connected';
    el.classList.add('connected');
    alert('Trainerize connected!\n\nIn production, this syncs your client programming automatically via Trainerize API.\n\nWorkouts will appear in each client\'s program.');
  } else {
    el.textContent = 'Connect';
    el.classList.remove('connected');
    alert('Trainerize disconnected');
  }
}

function importFromTrainerize() {
  if (!sources.trainerize) {
    alert('Please connect Trainerize first from the Clients page.');
    return;
  }
  alert('Importing workouts from Trainerize...\n\nIn production, this pulls the client\'s assigned program from Trainerize API.');
  // Simulate import
  setTimeout(() => {
    alert('✓ 12 workouts imported for this month!');
    renderBuilderCalendar();
  }, 1000);
}

// FatSecret Integration
function connectFatSecret() {
  sources.fatsecret = !sources.fatsecret;
  localStorage.setItem('fitsync_sources', JSON.stringify(sources));
  const el = document.getElementById('fatsecret-status');
  
  if (sources.fatsecret) {
    el.textContent = 'Connected';
    el.classList.add('connected');
    
    // In production: OAuth redirect to FatSecret
    // FatSecret API: https://platform.fatsecret.com/api/
    alert('FatSecret connected!\n\nIn production, this uses OAuth to sync your daily nutrition automatically.\n\nFor demo, simulating today\'s data sync...');
    
    // Simulate syncing today's nutrition from FatSecret
    const today = biometrics[biometrics.length - 1];
    if (today) {
      today.protein = 148;
      today.carbs = 192;
      today.fats = 62;
      today.calories = 1940;
      localStorage.setItem('fitsync_biometrics', JSON.stringify(biometrics));
      updateUI();
    }
  } else {
    el.textContent = 'Connect';
    el.classList.remove('connected');
    alert('FatSecret disconnected');
  }
}

init();
</script>
</body>
</html>
