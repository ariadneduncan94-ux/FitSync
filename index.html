<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Ari's FitSync</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #000; color: #fff; }
    .app { max-width: 430px; margin: 0 auto; min-height: 100vh; background: #000; position: relative; padding-bottom: 90px; }
    .header { background: #000; padding: 50px 20px 12px; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 24px; font-weight: 800; letter-spacing: -1px; }
    .accent { color: #4169E1; }
    .role-badge { font-size: 10px; padding: 6px 12px; border-radius: 20px; background: #1a1a1a; border: 1px solid #333; cursor: pointer; }
    .role-badge.trainer { background: #4169E120; border-color: #4169E1; color: #4169E1; }
    .card { background: #111; margin: 12px 16px; border-radius: 16px; padding: 18px; border: 1px solid #222; }
    .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; font-size: 11px; font-weight: 600; color: #888; letter-spacing: 1.5px; }
    .stats-row { display: flex; justify-content: space-around; align-items: center; }
    .stat-item { text-align: center; flex: 1; }
    .stat-value { font-size: 28px; font-weight: 700; }
    .stat-label { font-size: 10px; color: #666; margin-top: 4px; text-transform: uppercase; letter-spacing: 1px; }
    .stat-divider { width: 1px; height: 40px; background: #333; }
    .recovery-high { color: #00ff88; }
    .recovery-med { color: #ffcc00; }
    .recovery-low { color: #4169E1; }
    .screen { display: none; }
    .screen.active { display: block; }
    .tab-bar { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 430px; background: #111; display: flex; border-top: 1px solid #222; padding: 10px 0 25px; z-index: 50; }
    .tab { flex: 1; text-align: center; cursor: pointer; color: #555; font-size: 10px; font-weight: 500; }
    .tab.active { color: #4169E1; }
    .tab-icon { font-size: 20px; display: block; margin-bottom: 4px; }
    .fab { position: fixed; bottom: 100px; right: calc(50% - 195px); width: 56px; height: 56px; border-radius: 28px; background: #4169E1; color: #fff; border: none; font-size: 28px; cursor: pointer; box-shadow: 0 4px 20px rgba(65,105,225,0.4); z-index: 50; }
  </style>
</head>
<body>
<div class="app">
  <div class="header">
    <h1>Ari's <span class="accent">FitSync</span></h1>
    <div class="role-badge" id="role-badge" onclick="toggleRole()">CLIENT</div>
  </div>

  <!-- CLIENT: Dashboard -->
  <div id="dashboard" class="screen active">
    <div class="card">
      <div class="card-header">‚ù§Ô∏è TODAY'S BIOMETRICS</div>
      <div class="stats-row">
        <div class="stat-item"><div class="stat-value recovery-high" id="recovery-score">78%</div><div class="stat-label">Recovery</div></div>
        <div class="stat-divider"></div>
        <div class="stat-item"><div class="stat-value" id="hrv-score">45</div><div class="stat-label">HRV</div></div>
        <div class="stat-divider"></div>
        <div class="stat-item"><div class="stat-value" id="strain-score">--</div><div class="stat-label">Strain</div></div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">üéØ TODAY'S NUTRITION TARGET</div>
      <div class="macro-grid" id="nutrition-targets"></div>
    </div>
    <div class="card">
      <div class="card-header">üìã TODAY'S WORKOUT <span class="scheduled-date" id="today-date"></span></div>
      <div id="todays-workout"></div>
    </div>
    <div class="card">
      <div class="card-header">üìÖ UPCOMING WORKOUTS</div>
      <div id="upcoming-workouts"></div>
    </div>
  </div>

  <!-- CLIENT: Program -->
  <div id="program" class="screen">
    <div style="padding:16px;">
      <div class="card-header">üìÖ MY PROGRAM</div>
      <div class="week-nav"><span onclick="prevWeek()">‚Üê</span><span id="week-label">This Week</span><span onclick="nextWeek()">‚Üí</span></div>
      <div id="program-calendar"></div>
    </div>
  </div>

  <!-- CLIENT: Analytics -->
  <div id="analytics" class="screen">
    <div style="padding:16px;">
      <div class="card-header">üìà ANALYTICS</div>
      <div class="time-toggle">
        <button class="time-btn active" onclick="setTimeRange('1M')">1M</button>
        <button class="time-btn" onclick="setTimeRange('3M')">3M</button>
        <button class="time-btn" onclick="setTimeRange('6M')">6M</button>
      </div>
      <div class="card" style="padding:12px;height:220px;"><canvas id="analyticsChart"></canvas></div>
      <div class="card-header" style="margin-top:16px;">METRICS</div>
      <div class="legend-grid" id="legend-grid"></div>
    </div>
  </div>

  <!-- TRAINER: Clients -->
  <div id="clients" class="screen">
    <div style="padding:16px;">
      <div class="card-header">üë• MY CLIENTS</div>
      <div id="clients-list"></div>
      <div class="card" style="margin-top:20px;">
        <div class="card-header">üì§ BULK UPLOAD PROGRAMMING</div>
        <p style="font-size:12px;color:#666;margin-bottom:12px;">Upload an Excel file with monthly workouts and nutrition targets for all clients.</p>
        <button class="btn-small" onclick="downloadTemplate()" style="margin-right:8px;">üì• Download Template</button>
        <label class="btn-small" style="background:#333;cursor:pointer;">
          üì§ Upload Excel
          <input type="file" accept=".xlsx,.xls,.csv" onchange="handleExcelUpload(event)" style="display:none;">
        </label>
      </div>
    </div>
  </div>

  <!-- TRAINER: Builder -->
  <div id="builder" class="screen">
    <div style="padding:16px;">
      <div class="card-header">üìù PROGRAM BUILDER <span id="builder-client-name"></span></div>
      <div class="week-nav"><span onclick="builderPrevWeek()">‚Üê</span><span id="builder-week-label">This Week</span><span onclick="builderNextWeek()">‚Üí</span></div>
      <div id="builder-calendar"></div>
      <div class="card" style="margin-top:16px;">
        <div class="card-header">üéØ NUTRITION TARGETS</div>
        <div class="nutrition-inputs">
          <div class="nut-input"><label>Protein</label><input type="number" id="nut-protein" placeholder="g"></div>
          <div class="nut-input"><label>Carbs</label><input type="number" id="nut-carbs" placeholder="g"></div>
          <div class="nut-input"><label>Fats</label><input type="number" id="nut-fats" placeholder="g"></div>
          <div class="nut-input"><label>Calories</label><input type="number" id="nut-calories" placeholder="kcal"></div>
        </div>
        <button class="btn-small" onclick="saveNutritionTargets()">Save Targets</button>
      </div>
    </div>
  </div>

  <!-- Settings -->
  <div id="settings" class="screen">
    <div style="padding:16px;">
      <div class="card">
        <div style="display:flex;align-items:center;gap:16px;">
          <div class="avatar">A</div>
          <div><div style="font-weight:600;font-size:18px;">Ari</div><div style="color:#666;font-size:13px;">ari@fitsync.app</div></div>
        </div>
      </div>
      <div class="card-header" style="margin:24px 0 12px;">DATA SOURCES</div>
      <div class="card">
        <div class="setting-row" onclick="toggleSource('whoop')"><span>‚ù§Ô∏è Whoop</span><span id="whoop-status" class="source-status">Connect</span></div>
        <div class="setting-row" onclick="toggleSource('apple')"><span>‚åö Apple Watch</span><span id="apple-status" class="source-status">Connect</span></div>
        <div class="setting-row" onclick="toggleSource('garmin')"><span>üèÉ Garmin</span><span id="garmin-status" class="source-status">Connect</span></div>
        <div class="setting-row" onclick="toggleSource('oura')"><span>üíç Oura Ring</span><span id="oura-status" class="source-status">Connect</span></div>
      </div>
      <div class="card-header" style="margin:24px 0 12px;">NUTRITION IMPORT</div>
      <div class="card">
        <div class="setting-row" onclick="connectFatSecret()">
          <span>ü•ó FatSecret</span>
          <span id="fatsecret-status" class="source-status">Connect</span>
        </div>
        <p style="font-size:11px;color:#555;padding:8px 0 0;">Sync your daily nutrition data automatically</p>
      </div>
      <button class="btn-outline" onclick="clearData()">Clear All Data</button>
    </div>
  </div>

  <button class="fab" id="fab-btn" onclick="handleFab()">+</button>

  <div class="tab-bar" id="client-tabs">
    <div class="tab active" onclick="showScreen('dashboard')"><span class="tab-icon">üè†</span>Home</div>
    <div class="tab" onclick="showScreen('program')"><span class="tab-icon">üìã</span>Program</div>
    <div class="tab" onclick="showScreen('analytics')"><span class="tab-icon">üìà</span>Analytics</div>
    <div class="tab" onclick="showScreen('settings')"><span class="tab-icon">‚öôÔ∏è</span>Settings</div>
  </div>
  <div class="tab-bar" id="trainer-tabs" style="display:none;">
    <div class="tab active" onclick="showScreen('clients')"><span class="tab-icon">üë•</span>Clients</div>
    <div class="tab" onclick="showScreen('builder')"><span class="tab-icon">üìù</span>Program</div>
    <div class="tab" onclick="showScreen('analytics')"><span class="tab-icon">üìà</span>Analytics</div>
    <div class="tab" onclick="showScreen('settings')"><span class="tab-icon">‚öôÔ∏è</span>Settings</div>
  </div>

  <!-- Log Workout Modal -->
  <div id="log-modal" class="modal">
    <div class="modal-content modal-full">
      <div class="modal-header"><span onclick="closeLogModal()">‚úï</span><span class="modal-title">LOG WORKOUT</span><span onclick="saveWorkoutLog()" style="color:#4169E1">Save</span></div>
      <div class="modal-body">
        <h2 id="log-workout-name" style="font-size:20px;margin-bottom:8px;"></h2>
        <div class="bio-row" style="margin-bottom:20px;">
          <div class="bio-item"><span class="bio-label">Recovery</span><span class="bio-value" id="log-recovery">--</span></div>
          <div class="bio-item"><span class="bio-label">HRV</span><span class="bio-value" id="log-hrv">--</span></div>
        </div>
        <div id="log-exercises"></div>
        <div class="card" style="margin-top:20px;background:#0a0a0a;">
          <div class="card-header">‚åö POST-WORKOUT SYNC</div>
          <p style="font-size:12px;color:#666;margin-bottom:12px;">Biometrics will auto-sync after saving.</p>
          <div class="bio-row">
            <div class="bio-item"><span class="bio-label">Strain</span><span class="bio-value" id="log-strain">--</span></div>
            <div class="bio-item"><span class="bio-label">Avg HR</span><span class="bio-value" id="log-hr">--</span></div>
            <div class="bio-item"><span class="bio-label">Calories</span><span class="bio-value" id="log-cal">--</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Workout Modal -->
  <div id="create-modal" class="modal">
    <div class="modal-content modal-full">
      <div class="modal-header"><span onclick="closeCreateModal()">‚úï</span><span class="modal-title">CREATE WORKOUT</span><span onclick="saveScheduledWorkout()" style="color:#4169E1">Save</span></div>
      <div class="modal-body">
        <label class="input-label">WORKOUT NAME</label>
        <input type="text" id="create-name" class="input" placeholder="e.g., Push Day A">
        <label class="input-label">SCHEDULED DATE</label>
        <input type="date" id="create-date" class="input">
        <label class="input-label">NOTES FOR CLIENT</label>
        <textarea id="create-notes" class="input" rows="2" placeholder="Focus on form..."></textarea>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:24px;">
          <label class="input-label" style="margin:0;">EXERCISES</label>
          <button class="add-exercise-btn" onclick="addCreateExercise()">+ Add</button>
        </div>
        <div id="create-exercises"></div>
      </div>
    </div>
  </div>

  <!-- View Modal -->
  <div id="view-modal" class="modal">
    <div class="modal-content modal-full">
      <div class="modal-header"><span onclick="closeViewModal()">‚úï</span><span class="modal-title">WORKOUT DETAILS</span><span></span></div>
      <div class="modal-body" id="view-content"></div>
    </div>
  </div>
</div>

<style>
  .modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.95); z-index:100; }
  .modal.active { display:flex; justify-content:center; align-items:flex-end; }
  .modal-full { background:#000; width:100%; max-width:430px; height:100%; overflow-y:auto; }
  .modal-header { display:flex; justify-content:space-between; align-items:center; padding:16px 20px; border-bottom:1px solid #222; position:sticky; top:0; background:#000; z-index:10; }
  .modal-header span { font-size:18px; cursor:pointer; width:50px; }
  .modal-header span:last-child { text-align:right; }
  .modal-title { font-size:11px; font-weight:600; color:#888; letter-spacing:2px; }
  .modal-body { padding:20px; }
  .input-label { display:block; font-size:10px; color:#666; letter-spacing:1px; margin-bottom:8px; margin-top:20px; }
  .input { width:100%; padding:14px; background:#111; border:1px solid #333; border-radius:10px; color:#fff; font-size:16px; resize:none; }
  .input:focus { outline:none; border-color:#4169E1; }
  .bio-row { display:flex; gap:8px; }
  .bio-item { flex:1; background:#111; border:1px solid #222; border-radius:10px; padding:10px; text-align:center; }
  .bio-label { display:block; font-size:9px; color:#666; }
  .bio-value { display:block; font-size:16px; font-weight:600; margin-top:2px; color:#00ff88; }
  .add-exercise-btn { background:transparent; border:1px solid #4169E1; color:#4169E1; padding:8px 12px; border-radius:6px; font-size:11px; cursor:pointer; }
  .exercise-card { background:#111; border:1px solid #222; border-radius:12px; padding:14px; margin-top:12px; }
  .exercise-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .exercise-name-input { background:transparent; border:none; color:#fff; font-size:15px; font-weight:600; width:80%; }
  .exercise-name-input:focus { outline:none; }
  .remove-btn { color:#4169E1; cursor:pointer; font-size:16px; }
  .sets-header { display:flex; font-size:9px; color:#666; padding:6px 0; border-bottom:1px solid #222; }
  .sets-header span { flex:1; text-align:center; }
  .sets-header span:first-child { flex:0.4; }
  .set-row { display:flex; align-items:center; padding:6px 0; border-bottom:1px solid #1a1a1a; }
  .set-row span:first-child { flex:0.4; color:#666; font-size:11px; text-align:center; }
  .set-input { flex:1; background:#1a1a1a; border:none; border-radius:6px; padding:10px; color:#fff; text-align:center; font-size:14px; margin:0 3px; }
  .set-input:focus { outline:none; background:#222; }
  .set-input.actual { color:#00ff88; }
  .add-set-btn { width:100%; padding:8px; background:transparent; border:1px dashed #333; border-radius:6px; color:#555; font-size:11px; cursor:pointer; margin-top:8px; }
  .week-nav { display:flex; justify-content:space-between; align-items:center; padding:12px 0; margin-bottom:12px; }
  .week-nav span { cursor:pointer; font-size:18px; color:#666; }
  .week-nav span:nth-child(2) { font-size:14px; font-weight:600; color:#fff; }
  .calendar-day { background:#111; border:1px solid #222; border-radius:12px; padding:14px; margin-bottom:10px; }
  .calendar-day.today { border-color:#4169E1; }
  .calendar-day-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .calendar-day-name { font-size:12px; color:#888; }
  .calendar-day-date { font-size:11px; color:#555; }
  .calendar-workout { background:#1a1a1a; border-radius:8px; padding:12px; margin-top:8px; cursor:pointer; }
  .calendar-workout.completed { border-left:3px solid #00ff88; }
  .calendar-workout.scheduled { border-left:3px solid #4169E1; }
  .calendar-workout-name { font-weight:600; font-size:14px; }
  .calendar-workout-meta { font-size:11px; color:#666; margin-top:4px; }
  .calendar-empty { color:#444; font-size:12px; font-style:italic; }
</style>

<style>
  .time-toggle { display:flex; gap:8px; margin:12px 0; }
  .time-btn { flex:1; padding:10px; background:#111; border:1px solid #222; border-radius:8px; color:#666; font-size:12px; font-weight:600; cursor:pointer; }
  .time-btn.active { background:#4169E1; border-color:#4169E1; color:#fff; }
  .legend-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .legend-item { display:flex; align-items:center; gap:8px; padding:12px; background:#111; border:1px solid #222; border-radius:10px; cursor:pointer; }
  .legend-item.active { border-color:#444; }
  .legend-dot { width:10px; height:10px; border-radius:5px; }
  .legend-text { font-size:11px; color:#666; }
  .legend-item.active .legend-text { color:#fff; }
  .client-card { background:#111; border:1px solid #222; border-radius:12px; padding:16px; margin-bottom:10px; cursor:pointer; display:flex; align-items:center; gap:14px; }
  .client-avatar { width:44px; height:44px; border-radius:22px; background:#4169E1; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:18px; }
  .client-name { font-weight:600; font-size:15px; }
  .client-meta { font-size:11px; color:#666; margin-top:2px; }
  .macro-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; }
  .macro-item { background:#1a1a1a; border-radius:10px; padding:12px 8px; text-align:center; }
  .macro-value { font-size:18px; font-weight:700; }
  .macro-label { font-size:9px; color:#666; margin-top:2px; }
  .macro-item.protein .macro-value { color:#ffaa00; }
  .macro-item.carbs .macro-value { color:#00aaff; }
  .macro-item.fats .macro-value { color:#ff66aa; }
  .macro-item.calories .macro-value { color:#fff; }
  .nutrition-inputs { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px; }
  .nut-input label { display:block; font-size:10px; color:#666; margin-bottom:4px; }
  .nut-input input { width:100%; padding:10px; background:#1a1a1a; border:1px solid #333; border-radius:8px; color:#fff; font-size:14px; }
  .btn-small { padding:12px 20px; background:#4169E1; border:none; border-radius:8px; color:#fff; font-size:12px; font-weight:600; cursor:pointer; }
  .avatar { width:50px; height:50px; border-radius:25px; background:#4169E1; display:flex; align-items:center; justify-content:center; font-size:22px; font-weight:700; }
  .setting-row { padding:14px 0; border-bottom:1px solid #222; display:flex; justify-content:space-between; cursor:pointer; }
  .setting-row:last-child { border-bottom:none; }
  .source-status { color:#4169E1; font-size:12px; }
  .source-status.connected { color:#00ff88; }
  .btn-outline { width:100%; padding:14px; background:transparent; color:#4169E1; border:1px solid #333; border-radius:10px; font-size:13px; cursor:pointer; margin-top:20px; }
  .scheduled-date { font-size:10px; color:#4169E1; }
</style>

<script>
let role = localStorage.getItem('fitsync_role') || 'client';
let completedWorkouts = JSON.parse(localStorage.getItem('fitsync_completed') || '[]');
let scheduledWorkouts = JSON.parse(localStorage.getItem('fitsync_scheduled') || '[]');
let biometrics = JSON.parse(localStorage.getItem('fitsync_biometrics') || '[]');
let nutritionTargets = JSON.parse(localStorage.getItem('fitsync_nutrition') || '{"protein":150,"carbs":200,"fats":60,"calories":2200}');
let sources = JSON.parse(localStorage.getItem('fitsync_sources') || '{}');
let activeMetrics = ['recovery', 'strain'];
let timeRange = '1M';
let currentWeekOffset = 0;
let builderWeekOffset = 0;
let selectedClient = 'demo';
let createExercises = [];
let currentLogWorkout = null;
let analyticsChart = null;

const clients = [
  { id: 'demo', name: 'Ari', email: 'ari@fitsync.app' },
  { id: 'john', name: 'John Smith', email: 'john@email.com' },
  { id: 'sarah', name: 'Sarah Johnson', email: 'sarah@email.com' }
];

const metricConfig = {
  recovery: { label: 'Recovery', color: '#00ff88', unit: '%' },
  strain: { label: 'Strain', color: '#4169E1', unit: '' },
  hrv: { label: 'HRV', color: '#00bfff', unit: 'ms' },
  sleep: { label: 'Sleep', color: '#aa66ff', unit: 'hrs' },
  restingHR: { label: 'Resting HR', color: '#ff6b6b', unit: 'bpm' },
  vo2max: { label: 'VO2 Max', color: '#ffd93d', unit: '' },
  bodyWeight: { label: 'Body Weight', color: '#c9c9c9', unit: 'lbs' },
  bodyFat: { label: 'Body Fat %', color: '#ff9f43', unit: '%' },
  squatPR: { label: 'Squat PR', color: '#00ff88', unit: 'lbs' },
  deadliftPR: { label: 'Deadlift PR', color: '#4169E1', unit: 'lbs' },
  benchPR: { label: 'Bench PR', color: '#ff6b6b', unit: 'lbs' },
  protein: { label: 'Protein', color: '#ffaa00', unit: 'g' },
  carbs: { label: 'Carbs', color: '#00aaff', unit: 'g' },
  fats: { label: 'Fats', color: '#ff66aa', unit: 'g' },
  calories: { label: 'Calories', color: '#ffffff', unit: '' }
};

function init() {
  generateDemoData();
  generateDemoSchedule();
  updateRole();
  updateUI();
}

function generateDemoData() {
  if (biometrics.length === 0) {
    const now = new Date();
    let squat = 185, deadlift = 225, bench = 135, weight = 175, bf = 18;
    for (let i = 180; i >= 0; i--) {
      const date = new Date(now); date.setDate(date.getDate() - i);
      if (i % 14 === 0) { squat += Math.floor(Math.random() * 10); deadlift += Math.floor(Math.random() * 10); bench += Math.floor(Math.random() * 5); }
      if (i % 7 === 0) { weight += (Math.random() - 0.5) * 2; bf += (Math.random() - 0.6) * 0.5; }
      biometrics.push({
        date: date.toISOString().split('T')[0],
        recovery: Math.floor(50 + Math.random() * 45),
        strain: +(8 + Math.random() * 10).toFixed(1),
        hrv: Math.floor(30 + Math.random() * 40),
        sleep: +(5.5 + Math.random() * 3).toFixed(1),
        restingHR: Math.floor(50 + Math.random() * 15),
        vo2max: +(42 + Math.random() * 8).toFixed(1),
        bodyWeight: +weight.toFixed(1),
        bodyFat: +Math.max(10, bf).toFixed(1),
        squatPR: squat, deadliftPR: deadlift, benchPR: bench,
        protein: Math.floor(100 + Math.random() * 100),
        carbs: Math.floor(150 + Math.random() * 150),
        fats: Math.floor(50 + Math.random() * 50),
        calories: Math.floor(1800 + Math.random() * 800)
      });
    }
    localStorage.setItem('fitsync_biometrics', JSON.stringify(biometrics));
  }
}

function generateDemoSchedule() {
  if (scheduledWorkouts.length === 0) {
    const templates = [
      { name: 'Push Day A', exercises: [{ name: 'Bench Press', sets: [{w:135,r:10},{w:155,r:8},{w:175,r:6}] }, { name: 'Shoulder Press', sets: [{w:65,r:10},{w:75,r:8}] }] },
      { name: 'Pull Day A', exercises: [{ name: 'Deadlift', sets: [{w:185,r:8},{w:225,r:6},{w:245,r:4}] }, { name: 'Barbell Row', sets: [{w:95,r:10},{w:115,r:8}] }] },
      { name: 'Leg Day', exercises: [{ name: 'Squat', sets: [{w:135,r:10},{w:185,r:8},{w:205,r:6}] }, { name: 'Leg Press', sets: [{w:270,r:12},{w:360,r:10}] }] }
    ];
    const now = new Date();
    for (let i = -7; i < 28; i++) {
      if (i % 2 === 0 || i % 3 === 0) continue;
      const date = new Date(now); date.setDate(date.getDate() + i);
      const t = templates[Math.abs(i) % templates.length];
      scheduledWorkouts.push({ id: 'sched_' + Date.now() + '_' + i, clientId: 'demo', date: date.toISOString().split('T')[0], name: t.name, exercises: JSON.parse(JSON.stringify(t.exercises)), notes: 'Focus on form.' });
    }
    localStorage.setItem('fitsync_scheduled', JSON.stringify(scheduledWorkouts));
  }
}
</script>

<script>
function toggleRole() { role = role === 'client' ? 'trainer' : 'client'; localStorage.setItem('fitsync_role', role); updateRole(); }

function updateRole() {
  const badge = document.getElementById('role-badge');
  badge.textContent = role.toUpperCase();
  badge.classList.toggle('trainer', role === 'trainer');
  document.getElementById('client-tabs').style.display = role === 'client' ? 'flex' : 'none';
  document.getElementById('trainer-tabs').style.display = role === 'trainer' ? 'flex' : 'none';
  document.getElementById('fab-btn').style.display = role === 'trainer' ? 'block' : 'none';
  showScreen(role === 'client' ? 'dashboard' : 'clients');
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (event?.target) event.target.closest('.tab')?.classList.add('active');
  if (id === 'analytics') renderAnalytics();
  if (id === 'program') renderProgramCalendar();
  if (id === 'clients') renderClients();
  if (id === 'builder') renderBuilderCalendar();
  updateUI();
}

function handleFab() { if (role === 'trainer') openCreateModal(); }

function updateUI() {
  const today = biometrics[biometrics.length - 1] || {};
  document.getElementById('recovery-score').textContent = today.recovery ? today.recovery + '%' : '--';
  document.getElementById('recovery-score').className = 'stat-value ' + (today.recovery >= 67 ? 'recovery-high' : today.recovery >= 34 ? 'recovery-med' : 'recovery-low');
  document.getElementById('hrv-score').textContent = today.hrv || '--';
  document.getElementById('strain-score').textContent = today.strain || '--';
  
  document.getElementById('nutrition-targets').innerHTML = `
    <div class="macro-item protein"><div class="macro-value">${nutritionTargets.protein}g</div><div class="macro-label">PROTEIN</div></div>
    <div class="macro-item carbs"><div class="macro-value">${nutritionTargets.carbs}g</div><div class="macro-label">CARBS</div></div>
    <div class="macro-item fats"><div class="macro-value">${nutritionTargets.fats}g</div><div class="macro-label">FATS</div></div>
    <div class="macro-item calories"><div class="macro-value">${nutritionTargets.calories}</div><div class="macro-label">KCAL</div></div>`;
  
  const todayStr = new Date().toISOString().split('T')[0];
  document.getElementById('today-date').textContent = new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
  const todayWorkout = scheduledWorkouts.find(w => w.date === todayStr && w.clientId === 'demo');
  const todayCompleted = completedWorkouts.find(w => w.scheduledId && scheduledWorkouts.find(s => s.id === w.scheduledId)?.date === todayStr);
  
  if (todayCompleted) {
    document.getElementById('todays-workout').innerHTML = `<div class="calendar-workout completed" onclick="viewCompleted('${todayCompleted.id}')"><div class="calendar-workout-name">‚úì ${todayCompleted.name}</div><div class="calendar-workout-meta">Completed ‚Ä¢ Strain: ${todayCompleted.strain || '--'}</div></div>`;
  } else if (todayWorkout) {
    document.getElementById('todays-workout').innerHTML = `<div class="calendar-workout scheduled" onclick="openLogModal('${todayWorkout.id}')"><div class="calendar-workout-name">${todayWorkout.name}</div><div class="calendar-workout-meta">${todayWorkout.exercises.length} exercises ‚Ä¢ Tap to log</div></div>`;
  } else {
    document.getElementById('todays-workout').innerHTML = '<div class="calendar-empty">Rest day</div>';
  }
  
  const upcoming = scheduledWorkouts.filter(w => w.date > todayStr && w.clientId === 'demo').sort((a,b) => a.date.localeCompare(b.date)).slice(0, 3);
  document.getElementById('upcoming-workouts').innerHTML = upcoming.length ? upcoming.map(w => `<div class="calendar-workout scheduled" style="margin-top:8px;"><div class="calendar-workout-name">${w.name}</div><div class="calendar-workout-meta">${new Date(w.date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</div></div>`).join('') : '<div class="calendar-empty">No upcoming workouts</div>';
  
  ['whoop', 'apple', 'garmin', 'oura', 'fatsecret'].forEach(s => {
    const el = document.getElementById(s + '-status');
    if (el) { el.textContent = sources[s] ? 'Connected' : 'Connect'; el.classList.toggle('connected', sources[s]); }
  });
}

function getWeekDates(offset = 0) {
  const now = new Date();
  const start = new Date(now); start.setDate(now.getDate() - now.getDay() + (offset * 7));
  return Array.from({length: 7}, (_, i) => { const d = new Date(start); d.setDate(start.getDate() + i); return d; });
}

function prevWeek() { currentWeekOffset--; renderProgramCalendar(); }
function nextWeek() { currentWeekOffset++; renderProgramCalendar(); }

function renderProgramCalendar() {
  const days = getWeekDates(currentWeekOffset);
  const todayStr = new Date().toISOString().split('T')[0];
  document.getElementById('week-label').textContent = currentWeekOffset === 0 ? 'This Week' : days[0].toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' - ' + days[6].toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  document.getElementById('program-calendar').innerHTML = days.map(d => {
    const dateStr = d.toISOString().split('T')[0];
    const scheduled = scheduledWorkouts.find(w => w.date === dateStr && w.clientId === 'demo');
    const completed = completedWorkouts.find(w => w.scheduledId && scheduledWorkouts.find(s => s.id === w.scheduledId)?.date === dateStr);
    return `<div class="calendar-day ${dateStr === todayStr ? 'today' : ''}"><div class="calendar-day-header"><span class="calendar-day-name">${d.toLocaleDateString('en-US', { weekday: 'short' })}</span><span class="calendar-day-date">${d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span></div>${completed ? `<div class="calendar-workout completed" onclick="viewCompleted('${completed.id}')"><div class="calendar-workout-name">‚úì ${completed.name}</div></div>` : scheduled ? `<div class="calendar-workout scheduled" onclick="openLogModal('${scheduled.id}')"><div class="calendar-workout-name">${scheduled.name}</div></div>` : '<div class="calendar-empty">Rest</div>'}</div>`;
  }).join('');
}
</script>

<script>
function openLogModal(scheduledId) {
  const workout = scheduledWorkouts.find(w => w.id === scheduledId);
  if (!workout) return;
  currentLogWorkout = JSON.parse(JSON.stringify(workout));
  const today = biometrics[biometrics.length - 1] || {};
  document.getElementById('log-workout-name').textContent = workout.name;
  document.getElementById('log-recovery').textContent = today.recovery ? today.recovery + '%' : '--';
  document.getElementById('log-hrv').textContent = today.hrv ? today.hrv + 'ms' : '--';
  document.getElementById('log-strain').textContent = '--';
  document.getElementById('log-hr').textContent = '--';
  document.getElementById('log-cal').textContent = '--';
  renderLogExercises();
  document.getElementById('log-modal').classList.add('active');
}
function closeLogModal() { document.getElementById('log-modal').classList.remove('active'); currentLogWorkout = null; }

function renderLogExercises() {
  document.getElementById('log-exercises').innerHTML = currentLogWorkout.exercises.map((ex, exIdx) => `
    <div class="exercise-card"><div class="exercise-header"><span style="font-weight:600;font-size:15px;">${ex.name}</span></div>
    <div class="sets-header"><span>SET</span><span>TARGET</span><span>ACTUAL LBS</span><span>ACTUAL REPS</span></div>
    ${ex.sets.map((set, setIdx) => `<div class="set-row"><span>${setIdx + 1}</span><span style="flex:1;text-align:center;color:#666;font-size:12px;">${set.w || 0} √ó ${set.r || 0}</span><input type="number" class="set-input actual" placeholder="${set.w || 0}" data-ex="${exIdx}" data-set="${setIdx}" data-field="actualW"><input type="number" class="set-input actual" placeholder="${set.r || 0}" data-ex="${exIdx}" data-set="${setIdx}" data-field="actualR"></div>`).join('')}</div>`).join('');
}

function saveWorkoutLog() {
  if (!currentLogWorkout) return;
  document.querySelectorAll('#log-exercises .set-input').forEach(input => {
    const exIdx = parseInt(input.dataset.ex), setIdx = parseInt(input.dataset.set), field = input.dataset.field;
    const val = parseFloat(input.value) || parseFloat(input.placeholder) || 0;
    if (field === 'actualW') currentLogWorkout.exercises[exIdx].sets[setIdx].actualW = val;
    if (field === 'actualR') currentLogWorkout.exercises[exIdx].sets[setIdx].actualR = val;
  });
  const totalVolume = currentLogWorkout.exercises.reduce((sum, ex) => sum + ex.sets.reduce((s, set) => s + (set.actualW || set.w || 0) * (set.actualR || set.r || 0), 0), 0);
  const today = biometrics[biometrics.length - 1] || {};
  const strain = +(8 + Math.random() * 10).toFixed(1), avgHR = Math.floor(120 + Math.random() * 40), calories = Math.floor(200 + Math.random() * 300);
  completedWorkouts.unshift({ id: 'comp_' + Date.now(), scheduledId: currentLogWorkout.id, name: currentLogWorkout.name, exercises: currentLogWorkout.exercises, date: new Date().toISOString(), recovery: today.recovery, hrv: today.hrv, strain, avgHR, calories, totalVolume });
  localStorage.setItem('fitsync_completed', JSON.stringify(completedWorkouts));
  closeLogModal(); updateUI(); renderProgramCalendar();
  alert(`Workout logged!\nStrain: ${strain}\nAvg HR: ${avgHR} bpm\nCalories: ${calories}`);
}

function viewCompleted(id) {
  const w = completedWorkouts.find(x => x.id === id);
  if (!w) return;
  document.getElementById('view-content').innerHTML = `<h2 style="font-size:22px;font-weight:700;margin-bottom:6px;">${w.name}</h2><p style="color:#666;font-size:12px;margin-bottom:20px;">${new Date(w.date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</p><div class="bio-row" style="margin-bottom:20px;"><div class="bio-item"><span class="bio-label">Recovery</span><span class="bio-value" style="color:#00ff88">${w.recovery || '--'}%</span></div><div class="bio-item"><span class="bio-label">HRV</span><span class="bio-value" style="color:#00bfff">${w.hrv || '--'}</span></div><div class="bio-item"><span class="bio-label">Strain</span><span class="bio-value" style="color:#4169E1">${w.strain || '--'}</span></div><div class="bio-item"><span class="bio-label">Avg HR</span><span class="bio-value" style="color:#ff66aa">${w.avgHR || '--'}</span></div></div><div class="card-header">EXERCISES</div>${w.exercises.map(ex => `<div class="exercise-card" style="margin-bottom:10px;"><div style="font-weight:600;font-size:14px;margin-bottom:10px;">${ex.name}</div>${ex.sets.map((s, i) => `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #1a1a1a;font-size:13px;"><span style="color:#666">Set ${i+1}</span><span><span style="color:#666">${s.w}√ó${s.r}</span> ‚Üí <span style="color:#00ff88">${s.actualW || s.w} √ó ${s.actualR || s.r}</span></span></div>`).join('')}</div>`).join('')}<div style="margin-top:20px;padding:16px;background:#111;border-radius:12px;text-align:center;"><div style="font-size:11px;color:#666;">TOTAL VOLUME</div><div style="font-size:28px;font-weight:700;color:#4169E1;">${w.totalVolume?.toLocaleString() || 0} lbs</div></div>`;
  document.getElementById('view-modal').classList.add('active');
}
function closeViewModal() { document.getElementById('view-modal').classList.remove('active'); }

function renderClients() {
  document.getElementById('clients-list').innerHTML = clients.map(c => `<div class="client-card" onclick="selectClient('${c.id}')"><div class="client-avatar">${c.name[0]}</div><div><div class="client-name">${c.name}</div><div class="client-meta">${c.email}</div></div><span style="color:#666">‚Üí</span></div>`).join('');
}

function selectClient(id) {
  selectedClient = id;
  const client = clients.find(c => c.id === id);
  document.getElementById('builder-client-name').textContent = '‚Ä¢ ' + client.name;
  document.getElementById('nut-protein').value = nutritionTargets.protein;
  document.getElementById('nut-carbs').value = nutritionTargets.carbs;
  document.getElementById('nut-fats').value = nutritionTargets.fats;
  document.getElementById('nut-calories').value = nutritionTargets.calories;
  showScreen('builder');
}

function builderPrevWeek() { builderWeekOffset--; renderBuilderCalendar(); }
function builderNextWeek() { builderWeekOffset++; renderBuilderCalendar(); }

function renderBuilderCalendar() {
  const days = getWeekDates(builderWeekOffset);
  document.getElementById('builder-week-label').textContent = builderWeekOffset === 0 ? 'This Week' : days[0].toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' - ' + days[6].toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  document.getElementById('builder-calendar').innerHTML = days.map(d => {
    const dateStr = d.toISOString().split('T')[0];
    const scheduled = scheduledWorkouts.filter(w => w.date === dateStr && w.clientId === selectedClient);
    return `<div class="calendar-day"><div class="calendar-day-header"><span class="calendar-day-name">${d.toLocaleDateString('en-US', { weekday: 'short' })}</span><span class="calendar-day-date">${d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span></div>${scheduled.map(w => `<div class="calendar-workout scheduled" onclick="editScheduledWorkout('${w.id}')"><div class="calendar-workout-name">${w.name}</div></div>`).join('')}<div class="add-set-btn" onclick="openCreateModalForDate('${dateStr}')">+ Add Workout</div></div>`;
  }).join('');
}

function saveNutritionTargets() {
  nutritionTargets = { protein: parseInt(document.getElementById('nut-protein').value) || 150, carbs: parseInt(document.getElementById('nut-carbs').value) || 200, fats: parseInt(document.getElementById('nut-fats').value) || 60, calories: parseInt(document.getElementById('nut-calories').value) || 2200 };
  localStorage.setItem('fitsync_nutrition', JSON.stringify(nutritionTargets));
  alert('Nutrition targets saved!');
}
</script>

<script>
function openCreateModal() { openCreateModalForDate(new Date().toISOString().split('T')[0]); }

function openCreateModalForDate(dateStr) {
  createExercises = [{ name: '', sets: [{ w: '', r: '' }] }];
  document.getElementById('create-name').value = '';
  document.getElementById('create-date').value = dateStr;
  document.getElementById('create-notes').value = '';
  renderCreateExercises();
  document.getElementById('create-modal').classList.add('active');
}
function closeCreateModal() { document.getElementById('create-modal').classList.remove('active'); }

function addCreateExercise() { createExercises.push({ name: '', sets: [{ w: '', r: '' }] }); renderCreateExercises(); }
function removeCreateExercise(idx) { createExercises.splice(idx, 1); renderCreateExercises(); }
function addCreateSet(exIdx) { createExercises[exIdx].sets.push({ w: '', r: '' }); renderCreateExercises(); }

function renderCreateExercises() {
  document.getElementById('create-exercises').innerHTML = createExercises.map((ex, exIdx) => `
    <div class="exercise-card"><div class="exercise-header"><input type="text" class="exercise-name-input" placeholder="Exercise name" value="${ex.name}" onchange="createExercises[${exIdx}].name=this.value"><span class="remove-btn" onclick="removeCreateExercise(${exIdx})">‚úï</span></div>
    <div class="sets-header"><span>SET</span><span>WEIGHT</span><span>REPS</span></div>
    ${ex.sets.map((set, setIdx) => `<div class="set-row"><span>${setIdx + 1}</span><input type="number" class="set-input" placeholder="0" value="${set.w}" onchange="createExercises[${exIdx}].sets[${setIdx}].w=this.value"><input type="number" class="set-input" placeholder="0" value="${set.r}" onchange="createExercises[${exIdx}].sets[${setIdx}].r=this.value"></div>`).join('')}
    <button class="add-set-btn" onclick="addCreateSet(${exIdx})">+ Add Set</button></div>`).join('');
}

function saveScheduledWorkout() {
  const name = document.getElementById('create-name').value, date = document.getElementById('create-date').value, notes = document.getElementById('create-notes').value;
  if (!name || !date) { alert('Please enter name and date'); return; }
  const validExercises = createExercises.filter(e => e.name).map(e => ({ name: e.name, sets: e.sets.filter(s => s.w || s.r).map(s => ({ w: parseInt(s.w) || 0, r: parseInt(s.r) || 0 })) }));
  if (validExercises.length === 0) { alert('Add at least one exercise'); return; }
  scheduledWorkouts.push({ id: 'sched_' + Date.now(), clientId: selectedClient, date, name, notes, exercises: validExercises });
  localStorage.setItem('fitsync_scheduled', JSON.stringify(scheduledWorkouts));
  closeCreateModal(); renderBuilderCalendar();
  alert('Workout scheduled!');
}

function editScheduledWorkout(id) {
  const w = scheduledWorkouts.find(x => x.id === id);
  if (!w) return;
  createExercises = JSON.parse(JSON.stringify(w.exercises));
  document.getElementById('create-name').value = w.name;
  document.getElementById('create-date').value = w.date;
  document.getElementById('create-notes').value = w.notes || '';
  renderCreateExercises();
  scheduledWorkouts = scheduledWorkouts.filter(x => x.id !== id);
  document.getElementById('create-modal').classList.add('active');
}

function setTimeRange(range) {
  timeRange = range;
  document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  renderAnalytics();
}

function toggleMetric(metric) {
  const idx = activeMetrics.indexOf(metric);
  if (idx >= 0) activeMetrics.splice(idx, 1);
  else if (activeMetrics.length < 4) activeMetrics.push(metric);
  renderAnalytics();
}

function renderAnalytics() {
  const days = timeRange === '1M' ? 30 : timeRange === '3M' ? 90 : 180;
  const data = biometrics.slice(-days);
  
  document.getElementById('legend-grid').innerHTML = Object.entries(metricConfig).map(([key, cfg]) => `
    <div class="legend-item ${activeMetrics.includes(key) ? 'active' : ''}" onclick="toggleMetric('${key}')">
      <div class="legend-dot" style="background:${cfg.color}"></div>
      <span class="legend-text">${cfg.label}</span>
    </div>`).join('');
  
  const ctx = document.getElementById('analyticsChart').getContext('2d');
  if (analyticsChart) analyticsChart.destroy();
  
  const datasets = activeMetrics.map(metric => {
    const cfg = metricConfig[metric];
    let values = data.map(d => parseFloat(d[metric]) || 0);
    // Normalize for display
    const max = Math.max(...values);
    if (max > 100) values = values.map(v => (v / max) * 100);
    return { label: cfg.label, data: values, borderColor: cfg.color, borderWidth: 2, pointRadius: 0, tension: 0.4, fill: false };
  });
  
  analyticsChart = new Chart(ctx, {
    type: 'line',
    data: { labels: data.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })), datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1a1a1a', callbacks: { label: ctx => { const m = activeMetrics[ctx.datasetIndex]; return `${metricConfig[m].label}: ${biometrics.slice(-days)[ctx.dataIndex][m]}${metricConfig[m].unit}`; } } } },
      scales: { x: { grid: { color: '#222' }, ticks: { color: '#666', maxTicksLimit: 6 } }, y: { grid: { color: '#222' }, ticks: { color: '#666' }, min: 0, max: 100 } }
    }
  });
}

function toggleSource(source) {
  sources[source] = !sources[source];
  localStorage.setItem('fitsync_sources', JSON.stringify(sources));
  updateUI();
  if (sources[source]) alert(source.charAt(0).toUpperCase() + source.slice(1) + ' connected!');
}

function clearData() { if (confirm('Clear all data?')) { localStorage.clear(); location.reload(); } }

// Excel Template Download
function downloadTemplate() {
  const template = `Client Email,Date,Workout Name,Exercise,Sets,Weight,Reps,Notes,Protein Target,Carbs Target,Fats Target,Calories Target
ari@fitsync.app,2024-01-15,Push Day A,Bench Press,3,135,10,Focus on form,150,200,60,2200
ari@fitsync.app,2024-01-15,Push Day A,Shoulder Press,3,65,10,,,,
ari@fitsync.app,2024-01-15,Push Day A,Tricep Dips,3,BW,12,,,,
ari@fitsync.app,2024-01-17,Pull Day A,Deadlift,4,185,8,Keep back straight,150,200,60,2200
ari@fitsync.app,2024-01-17,Pull Day A,Barbell Row,3,95,10,,,,
ari@fitsync.app,2024-01-19,Leg Day,Squat,4,155,8,Full depth,160,220,55,2300
ari@fitsync.app,2024-01-19,Leg Day,Leg Press,3,270,12,,,,
john@email.com,2024-01-15,Upper Body,Bench Press,4,185,6,,180,250,70,2600
john@email.com,2024-01-17,Lower Body,Squat,4,225,6,,180,250,70,2600`;
  
  const blob = new Blob([template], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'FitSync_Programming_Template.csv';
  a.click();
  URL.revokeObjectURL(url);
}

// Excel/CSV Upload Handler
function handleExcelUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const text = e.target.result;
    parseAndImportProgram(text);
  };
  reader.readAsText(file);
  event.target.value = '';
}

function parseAndImportProgram(csvText) {
  const lines = csvText.trim().split('\n');
  if (lines.length < 2) { alert('Empty or invalid file'); return; }
  
  const header = lines[0].split(',').map(h => h.trim().toLowerCase());
  const emailIdx = header.findIndex(h => h.includes('email'));
  const dateIdx = header.findIndex(h => h.includes('date'));
  const workoutIdx = header.findIndex(h => h.includes('workout'));
  const exerciseIdx = header.findIndex(h => h.includes('exercise'));
  const setsIdx = header.findIndex(h => h.includes('sets'));
  const weightIdx = header.findIndex(h => h.includes('weight'));
  const repsIdx = header.findIndex(h => h.includes('reps'));
  const notesIdx = header.findIndex(h => h.includes('notes'));
  const proteinIdx = header.findIndex(h => h.includes('protein'));
  const carbsIdx = header.findIndex(h => h.includes('carbs'));
  const fatsIdx = header.findIndex(h => h.includes('fats'));
  const caloriesIdx = header.findIndex(h => h.includes('calories'));
  
  if (emailIdx < 0 || dateIdx < 0 || workoutIdx < 0) {
    alert('Missing required columns: Client Email, Date, Workout Name');
    return;
  }
  
  const workoutMap = {};
  const nutritionMap = {};
  let importedCount = 0;
  
  for (let i = 1; i < lines.length; i++) {
    const cols = lines[i].split(',').map(c => c.trim());
    if (cols.length < 3) continue;
    
    const email = cols[emailIdx];
    const date = cols[dateIdx];
    const workoutName = cols[workoutIdx];
    const exercise = cols[exerciseIdx] || '';
    const numSets = parseInt(cols[setsIdx]) || 3;
    const weight = cols[weightIdx] || '0';
    const reps = parseInt(cols[repsIdx]) || 10;
    const notes = cols[notesIdx] || '';
    
    // Find client by email
    let clientId = clients.find(c => c.email.toLowerCase() === email.toLowerCase())?.id;
    if (!clientId) {
      // Create new client
      clientId = 'client_' + Date.now() + '_' + i;
      const name = email.split('@')[0].replace(/[^a-zA-Z]/g, ' ').trim();
      clients.push({ id: clientId, name: name.charAt(0).toUpperCase() + name.slice(1), email });
    }
    
    const key = `${clientId}_${date}_${workoutName}`;
    if (!workoutMap[key]) {
      workoutMap[key] = {
        id: 'sched_import_' + Date.now() + '_' + i,
        clientId,
        date,
        name: workoutName,
        notes,
        exercises: []
      };
    }
    
    if (exercise) {
      const sets = [];
      const w = weight === 'BW' ? 0 : parseInt(weight) || 0;
      for (let s = 0; s < numSets; s++) {
        sets.push({ w, r: reps });
      }
      workoutMap[key].exercises.push({ name: exercise, sets });
    }
    
    // Nutrition targets per client
    if (proteinIdx >= 0 && cols[proteinIdx]) {
      nutritionMap[clientId] = {
        protein: parseInt(cols[proteinIdx]) || 150,
        carbs: parseInt(cols[carbsIdx]) || 200,
        fats: parseInt(cols[fatsIdx]) || 60,
        calories: parseInt(cols[caloriesIdx]) || 2200
      };
    }
  }
  
  // Import workouts
  Object.values(workoutMap).forEach(w => {
    // Remove existing workout for same client/date/name
    scheduledWorkouts = scheduledWorkouts.filter(sw => 
      !(sw.clientId === w.clientId && sw.date === w.date && sw.name === w.name)
    );
    scheduledWorkouts.push(w);
    importedCount++;
  });
  
  localStorage.setItem('fitsync_scheduled', JSON.stringify(scheduledWorkouts));
  
  // Update nutrition for demo client if present
  if (nutritionMap['demo']) {
    nutritionTargets = nutritionMap['demo'];
    localStorage.setItem('fitsync_nutrition', JSON.stringify(nutritionTargets));
  }
  
  alert(`Imported ${importedCount} workouts!\n\nClients: ${[...new Set(Object.values(workoutMap).map(w => w.clientId))].length}`);
  renderClients();
  updateUI();
}

// FatSecret Integration
function connectFatSecret() {
  sources.fatsecret = !sources.fatsecret;
  localStorage.setItem('fitsync_sources', JSON.stringify(sources));
  const el = document.getElementById('fatsecret-status');
  
  if (sources.fatsecret) {
    el.textContent = 'Connected';
    el.classList.add('connected');
    
    // In production: OAuth redirect to FatSecret
    // FatSecret API: https://platform.fatsecret.com/api/
    alert('FatSecret connected!\n\nIn production, this uses OAuth to sync your daily nutrition automatically.\n\nFor demo, simulating today\'s data sync...');
    
    // Simulate syncing today's nutrition from FatSecret
    const today = biometrics[biometrics.length - 1];
    if (today) {
      today.protein = 148;
      today.carbs = 192;
      today.fats = 62;
      today.calories = 1940;
      localStorage.setItem('fitsync_biometrics', JSON.stringify(biometrics));
      updateUI();
    }
  } else {
    el.textContent = 'Connect';
    el.classList.remove('connected');
    alert('FatSecret disconnected');
  }
}

init();
</script>
</body>
</html>
