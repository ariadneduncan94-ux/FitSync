<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Import Exercises to Supabase</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #0a0a0a; color: #fff; padding: 40px; }
    .container { max-width: 800px; margin: 0 auto; }
    h1 { margin-bottom: 20px; }
    .card { background: #111; border: 1px solid #222; border-radius: 12px; padding: 24px; margin-bottom: 20px; }
    .btn { padding: 14px 28px; background: linear-gradient(135deg, #4169E1, #00ff88); border: none; border-radius: 10px; color: #fff; font-size: 16px; font-weight: 600; cursor: pointer; margin-right: 10px; margin-bottom: 10px; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(65, 105, 225, 0.4); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-secondary { background: #333; }
    .progress { background: #222; border-radius: 8px; height: 24px; overflow: hidden; margin: 20px 0; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, #4169E1, #00ff88); transition: width 0.3s; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; }
    .log { background: #0a0a0a; border: 1px solid #222; border-radius: 8px; padding: 16px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 13px; }
    .log-entry { margin-bottom: 4px; }
    .log-entry.success { color: #00ff88; }
    .log-entry.error { color: #ff6b6b; }
    .log-entry.info { color: #4169E1; }
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
    .stat { background: #1a1a1a; padding: 16px; border-radius: 8px; text-align: center; }
    .stat-value { font-size: 28px; font-weight: 700; color: #00ff88; }
    .stat-label { font-size: 12px; color: #666; margin-top: 4px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèãÔ∏è Exercise Database Import</h1>
    
    <div class="card">
      <h3 style="margin-bottom: 16px;">Import ExerciseDB ‚Üí Supabase</h3>
      <p style="color: #888; margin-bottom: 20px;">
        This will fetch all exercises from ExerciseDB API and store them in your Supabase database.
        The GIF URLs will be stored (not the actual images), so they'll load from ExerciseDB's CDN.
      </p>
      
      <div class="stats">
        <div class="stat">
          <div class="stat-value" id="stat-total">0</div>
          <div class="stat-label">Total Fetched</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="stat-inserted">0</div>
          <div class="stat-label">Inserted</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="stat-skipped">0</div>
          <div class="stat-label">Skipped</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="stat-errors">0</div>
          <div class="stat-label">Errors</div>
        </div>
      </div>
      
      <div class="progress">
        <div class="progress-bar" id="progress-bar" style="width: 0%;">0%</div>
      </div>
      
      <button class="btn" id="btn-start" onclick="startImport()">Start Import</button>
      <button class="btn btn-secondary" onclick="checkExisting()">Check Existing Count</button>
      <button class="btn btn-secondary" onclick="clearAll()">Clear All Exercises</button>
    </div>
    
    <div class="card">
      <h3 style="margin-bottom: 16px;">Log</h3>
      <div class="log" id="log"></div>
    </div>
  </div>

  <script>
    // Supabase config
    const SUPABASE_URL = 'https://brmxwnvwpgjmmjgqtzty.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJybXh3bnZ3cGdqbW1qZ3F0enR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0Mzg2ODksImV4cCI6MjA4MjAxNDY4OX0.sxAXUKgSgex9FSRReqNcFmpnAqlkN--QMPfXzfgee6k';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // ExerciseDB config
    const EXERCISEDB_API_KEY = '9124d57c83msh0c85c857c3a0ac7p1ce14bjsn778e0824ad6e';
    const EXERCISEDB_HOST = 'exercisedb.p.rapidapi.com';
    
    let stats = { total: 0, inserted: 0, skipped: 0, errors: 0 };
    
    function log(message, type = 'info') {
      const logEl = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }
    
    function updateStats() {
      document.getElementById('stat-total').textContent = stats.total;
      document.getElementById('stat-inserted').textContent = stats.inserted;
      document.getElementById('stat-skipped').textContent = stats.skipped;
      document.getElementById('stat-errors').textContent = stats.errors;
    }
    
    function updateProgress(current, total) {
      const pct = Math.round((current / total) * 100);
      const bar = document.getElementById('progress-bar');
      bar.style.width = pct + '%';
      bar.textContent = pct + '%';
    }
    
    async function checkExisting() {
      log('Checking existing exercises in Supabase...');
      const { count, error } = await supabase
        .from('exercises')
        .select('*', { count: 'exact', head: true });
      
      if (error) {
        log(`Error: ${error.message}`, 'error');
      } else {
        log(`Found ${count} exercises in database`, 'success');
      }
    }
    
    async function clearAll() {
      if (!confirm('Are you sure you want to delete ALL exercises from the database?')) return;
      
      log('Deleting all exercises...');
      const { error } = await supabase.from('exercises').delete().neq('id', '');
      
      if (error) {
        log(`Error: ${error.message}`, 'error');
      } else {
        log('All exercises deleted', 'success');
        stats = { total: 0, inserted: 0, skipped: 0, errors: 0 };
        updateStats();
      }
    }
    
    async function startImport() {
      const btn = document.getElementById('btn-start');
      btn.disabled = true;
      btn.textContent = 'Importing...';
      
      stats = { total: 0, inserted: 0, skipped: 0, errors: 0 };
      updateStats();
      
      try {
        // Fetch all exercises from ExerciseDB
        log('Fetching exercises from ExerciseDB API...');
        
        const response = await fetch('https://exercisedb.p.rapidapi.com/exercises?limit=2000&offset=0', {
          headers: {
            'x-rapidapi-host': EXERCISEDB_HOST,
            'x-rapidapi-key': EXERCISEDB_API_KEY
          }
        });
        
        if (!response.ok) {
          throw new Error(`API returned ${response.status}: ${response.statusText}`);
        }
        
        const exercises = await response.json();
        stats.total = exercises.length;
        updateStats();
        log(`Fetched ${exercises.length} exercises from API`, 'success');
        
        // Insert in batches of 50
        const batchSize = 50;
        const batches = [];
        
        for (let i = 0; i < exercises.length; i += batchSize) {
          batches.push(exercises.slice(i, i + batchSize));
        }
        
        log(`Processing ${batches.length} batches of ${batchSize} exercises...`);
        
        for (let i = 0; i < batches.length; i++) {
          const batch = batches[i];
          
          // Transform to our schema
          const records = batch.map(ex => ({
            id: ex.id,
            name: capitalizeWords(ex.name),
            body_part: ex.bodyPart,
            target_muscle: ex.target,
            equipment: ex.equipment,
            gif_url: ex.gifUrl,
            secondary_muscles: ex.secondaryMuscles || [],
            instructions: ex.instructions || []
          }));
          
          // Upsert to Supabase
          const { data, error } = await supabase
            .from('exercises')
            .upsert(records, { onConflict: 'id' });
          
          if (error) {
            log(`Batch ${i + 1} error: ${error.message}`, 'error');
            stats.errors += batch.length;
          } else {
            stats.inserted += batch.length;
            log(`Batch ${i + 1}/${batches.length} complete (${batch.length} exercises)`);
          }
          
          updateStats();
          updateProgress(i + 1, batches.length);
          
          // Small delay to avoid rate limits
          await new Promise(r => setTimeout(r, 100));
        }
        
        log(`Import complete! ${stats.inserted} exercises added.`, 'success');
        
      } catch (err) {
        log(`Error: ${err.message}`, 'error');
      }
      
      btn.disabled = false;
      btn.textContent = 'Start Import';
    }
    
    function capitalizeWords(str) {
      if (!str) return '';
      return str.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }
    
    // Check connection on load
    (async () => {
      log('Connecting to Supabase...');
      log(`URL: ${SUPABASE_URL}`);
      log(`Key: ${SUPABASE_ANON_KEY.substring(0, 20)}...`);
      
      try {
        const { data, error } = await supabase.from('exercises').select('count').limit(1);
        if (error) {
          log(`Connection error: ${error.message}`, 'error');
          log(`Error code: ${error.code}`, 'error');
          log('Make sure you ran exercises-table.sql first!', 'error');
        } else {
          log('Connected to Supabase successfully', 'success');
          checkExisting();
        }
      } catch (e) {
        log(`Exception: ${e.message}`, 'error');
      }
    })();
    
    // Also log any unhandled errors
    window.onerror = function(msg, url, line) {
      log(`JS Error: ${msg} at line ${line}`, 'error');
    };
  </script>
</body>
</html>
